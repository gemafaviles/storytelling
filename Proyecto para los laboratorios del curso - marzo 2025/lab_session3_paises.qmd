---
title: "Storytelling visual con R. Lab 3: demografÃ­a (cuantitativos)"
subtitle: "Curso formativo para el PDI. Universidad de Castilla-La Mancha"
author:   
  - name: Gema FernÃ¡ndez-AvilÃ©s 
    email: gema.faviles@uclm.es
  - name: Isidro Hidalgo
    email: isidro.hidalgo@uclm.es 
date: "`r Sys.Date()`"
format:
  html:
    theme: cerulean
    highlight-style: ayu-mirage
    self-contained: true
    lang: es
    date-format: long
    embed-resources: true
    toc-title: Summary
    toc: true
    number-sections: true
    preview-links: auto
    code-link: true
number-sections: true
execute:
  echo: true
  eval: true
  output: true
  include: true
  freeze: auto
  fig-height: 5
  warning: false
  comment: "#>"
  code-line-numbers: true
  code-copy: true
  code-overflow: scroll
---




::: {.callout-warning}
## IMPORTANTE

ğŸ“• **Como buen estudiante que eres, sabrÃ¡s lo importante que es trabajar de forma autÃ³noma y venir a clase con el material leÃ­do ğŸ˜Š**. 

ğŸ¦„ <mark> Este icono indica **AVANZADO E IMPORTANTE**</mark>

:::


# Los datos

Los datos que se utilizan en esta historia estÃ¡n disponibles en el repositorio GitHub "From data to viz": https://github.com/holtzy/data_to_viz. AdemÃ¡s, se ha facilitado un archivo Excel



# Â¡Nos vamos a Noruega! ğŸ¥¶

Â¡Ah, la vida del analista de datos! Mi jefe me ha pedido que realice un anÃ¡lisis exploratorio (aunque en realidad siempre quiere grÃ¡ficos impresionantes con conclusiones fascinantes) de unos datos demogrÃ¡ficos por paÃ­ses. Pero aquÃ­ viene lo mejor: quiere que lo acompaÃ±e a Noruega para un *workshop* "fantÃ¡stico" [sic]...

Con el frÃ­o que hace ahora en Noruega, uno se pregunta: Â¿por quÃ© no elige destinos con mÃ¡s criterio? Â¡HawÃ¡i, por ejemplo, serÃ­a una opciÃ³n mucho mÃ¡s cÃ¡lida y agradable!



::: {.callout-tip}

## Entender el contexto: cÃ³mo definir el propÃ³sito y la audiencia de tu anÃ¡lisis

En este caso, lo que me pide el jefe es un anÃ¡lisis exploratorio. BÃ¡sicamente, se trata de encontrar relaciones interesantes entre variables, observar su evoluciÃ³n para ver si surge algo llamativo, y preparar grÃ¡ficos que vayan al grano, como ya sabemos hacer... 

ğŸ“ Â¡Para eso sirven los cursos de la UCLM
:::


**Paso (i):** Lectura de paquetes

```{r}
library(tidyverse)
library(psych)
library(GGally)
library(corrplot)
library(plotly)
```


**Paso (ii):** Lectura de los datos 

+ OpciÃ³n (a): Lectura de datos formato `csv` directamente desde la web
```{r}
#| eval: false
demog_data <- read.table("https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/multivariate.csv", header = T, sep = ";")
```

+ OpciÃ³n (b): Lectura de datos formato `csv` (recuerda que mis datos estÃ¡n guardados en la carpeta `data`, Â¿los tuyos tambiÃ©n o no?)
```{r}
demog_data <- read.table("data/multivariate.csv", header = T, sep = ";")
```


::: {.callout-warning title="Tu turno"}
## Tu turno

Completa las partes del cÃ³digo seÃ±aladas por `_____` o `xxxxx` para obtener el resultado propuesto y acuÃ©rdate de cambiar `eval: false` por `eval: true` cuando lo hayas cumplimentado para que se ejecute correctamente la chunk.
:::



# Â¿CÃ³mo son mis datos?

**Paso 1** Muestra las primeras filas del conjunto de datos `demog_data`.

```{r}
#| eval: false
head(_______)
```


**Paso 2** Echa un vistazo a la estructura de las variables con la funciÃ³n `glimpse()`.

```{r}
#| eval: false
________(demog_data)
```


**Paso 3** Haz unos descriptivos bÃ¡sicos con la funciÃ³n `describe()` del paquete `psych`.

```{r}
#| eval: false
________(demog_data)
```


**Paso 4** AquÃ­ va otra opciÃ³n interesante con la funciÃ³n `skim()` del paquete `skim`.

```{r}
skimr::skim(demog_data)
```



# Elegir una visualizaciÃ³n adecuada

::: {.callout-tip}
## SelecciÃ³n de grÃ¡ficos y visualizaciones que mejor representen tus datos. En este caso la mayorÃ­a son variables cuantitativas.
:::

ğŸ“Š  **Matriz diagramas de dispersiÃ³n** (*scatterplot matrix*)

Podemos comenzar por una matriz de puntos de las variables cuantitativas. El paquete `GGally` ofrece una visualizaciÃ³n muy elaborada para un primer vistazo con la funciÃ³n `ggpairs()`.

::: {.callout-tip}
## Cuidado: solo variables cuantitativas.
:::


**Paso 1**  Selecciona las variables cuantitativas del conjunto de datos `demog_data` y guardarlas en el objeto `demo_cuanti`. 

```{r}
demo_cuanti <- demog_data |>
   select(Pop, Birth_rate, Mortality_rate, Life_expectancy,
          Infant_mortality, Child_per_woman,  Growth_rate,
          Pop_aged_65) |>
   na.omit()
```


**Paso 2** **Matriz de correlaciones y diagramas de dispersiÃ³n** con la funciÃ³n `ggpairs()` de la librerÃ­a `GGally`

```{r}
demo_cuanti |> 
   ggpairs(progress = FALSE)
```

ğŸ“Š  **Matriz de correlaciones** 

Hay muchas asociaciones interesantes entre diferentes variables. AquÃ­ ya vemos mucha tela que cortar. Por no extendernos, analizaremos una de las relaciones mÃ¡s adelante. Pero primero, es muy interesante ver la matriz de correlaciones que, aunque con `ggpairs()` tenÃ­amos ya una primera impresiÃ³n, el paquete `corrplot` nos ofrece una visualizaciÃ³n ideal con la funciÃ³n `corrplot.mixed()`


**Paso 3** Primero calculo la matriz de correlaciones con la funciÃ³n `cor()` y luego la represento con la funciÃ³n `corrplot.mixed()` que presenta mÃºltiples posibilidades.

```{r}
demo_cuanti |> 
  cor() |> 
  corrplot.mixed( order = 'AOE')
```


ğŸ“Š  **GrÃ¡fico de puntos o scatterplot** 


Como ejemplo, vamos a ver la relaciÃ³n entre la tasa de crecimiento, `Growth_rate`, y la esperanza de vida, `Life_expectancy`, que ya hemos visto que existe relaciÃ³n estadÃ­stica. Empecemos con diagrama de puntos.


**Paso 4** Â¿Te acuerdas de la funciÃ³n de `ggplot2` para una capa de puntos?

```{r}
#| eval: false
ggplot(demog_data,
         aes(x = Growth_rate, y = Life_expectancy)) +
  geom_xxxxxxxx() +
  labs(title = "Esperanza de vida vs. Tasa de crecimiento",
       x = "Tasa de crecimiento",
       y = "Esperanza de vida") +
  theme_minimal()
```



ğŸ“Š  **Hexbin plot** 

**Paso 5** Â¿Te acuerdas de la funciÃ³n de `ggplot2` para convertir puntos en densidades de forma hexagonal?
```{r}
#| eval: false
ggplot(demog_data,
       aes(x = Growth_rate, y = Life_expectancy)) +
  geom_xxx() +
  labs(title = "Esperanza de vida vs. Tasa de crecimiento",
       x = "Tasa de crecimiento",
       y = "Esperanza de vida") +
  theme_minimal()
```


ğŸ” **Eliminar el desorden. Enfocar la atenciÃ³n**

Â¿QuÃ© herramientas tenemos a nuestro alcance para poner el foco sobre lo que nos interesa? AquÃ­ podemos usar la estÃ©tica y las facetas, para separar los puntos y dar mÃ¡s informaciÃ³n a travÃ©s de la visualizaciÃ³n. Veamos...


**Paso 5** Diagrama de dispersiÃ³n mejorado por estÃ©tica incluyendo la variable `Pop` para el tamaÃ±o de los puntos.

```{r}
#| eval: false
  ggplot(demog_data,
         aes(x = Growth_rate, y = Life_expectancy, 
             _____ = Pop)) +
  scale_size(range = c(.1, 20)) +
  labs(title = "Esperanza de vida vs. Tasa de crecimiento",
       x = "Tasa de crecimiento",
       y = "Esperanza de vida") +
  theme_minimal() 
```


**Paso 6** AÃ±ade la variable `Continent` en el anÃ¡lisis para representar por colores los continentes en la estÃ©tica de la funciÃ³n `aes()`. AdemÃ¡s, aÃ±ade cierta transparencia porque puede que los puntos mÃ¡s grandes estÃ©n tapando a los mÃ¡s pequeÃ±os. Escribe el tÃ­tulo que consideres mÃ¡s apropiado. Ahora, el grÃ¡fico lo vamos a guardar en un objeto llamado `g_demog`.


```{r}
#| eval: false
g_demog <- ggplot(demog_data,
         aes(x = Growth_rate, y = Life_expectancy, 
             _____ = Pop,
             _____ = Continent)) +
  geom_point(_____ = 0.5) +
  scale_size(range = c(.1, 20)) +
  labs(title = "_______________________________",
       x = "Tasa de crecimiento",
       y = "Esperanza de vida") +
  theme_minimal() 

# para represenar el grÃ¡fico

g_demog
```


ğŸ“Š  **GrÃ¡ficos interactivos** 

**Paso 7** Hacemos interactivo el grÃ¡fico anterior con la funciÃ³n `ggplotly()` de la libreriÃ¡ `pltoly`.

```{r}
#| eval: false
ggplotly(_____)
```


Estamos usando **dos variables para enfocar la atenciÃ³n aportando informaciÃ³n: el tamaÃ±o del paÃ­s y el continente**. Solo con eso vemos enseguida por donde van los tiros: la mayor parte de los paÃ­ses de Europa tienen gran esperanza de vida y crecimiento moderado. Por el contrario, SudamÃ©rica tiene tasas de crecimiento muy elevadas (son paÃ­ses en fases de expansiÃ³n econÃ³mica) y una menor esperanza de vida, a falta de consolidar sanidad y otros servicios en general.

TambiÃ©n somos capaces de identificar China e India rÃ¡pidamente, por su tamaÃ±o, y JapÃ³n arriba a la izquierda por su tamaÃ±o medio-grande y enorme esperanza de vida.

Sin embargo, hay colores muy parecidos, que exigen demasiada atenciÃ³n. Podemos usar la siguiente herramienta...

 

ğŸ“Š  **Facetas** 

Otra forma de eliminar el desorden y enfocar la atenciÃ³n es usar facetas, separando el grÃ¡fico segÃºn una o mÃ¡s variables interesantes. En este caso usamos solo el continente.


ğŸ¦„ **Paso 8** Diagrama de dispersiÃ³n mejorado por facetas con la funciÃ³n `facet_wrap()`.

```{r}
demog_scatter <- ggplot(data = demog_data, # data
              aes(x = Growth_rate, y = Life_expectancy, colour = Continent)) + #aesthetics
    geom_point(alpha = 0.5) + #geometries
    facet_wrap(~ Continent, scales = "free") + #facets
    labs(title = "Life expectancy at birth vs. Per capita GDP", 
         x = "Growth_rate", y = "Life_expectancy", colour = "Continent") + #labels
    theme_light() #themes

demog_scatter 
```

â“ **Â¿QuÃ© problema podrÃ­a tener este grÃ¡fico?**

::: {.callout-tip}
## Pista

Â¡Fijaos en los ejes!
:::

Exacto: las escalas. Pero hemos dicho "podrÃ­a", no que tenga un problema en sÃ­. Cuando nuestra intenciÃ³n es mirar dentro de cada faceta para ver la relaciÃ³n entre las variables, es posible que nos interese dejarlo como estÃ¡.

Pero muchas veces es muy importante, cuando usamos facetas, que podamos comparar los diferentes grupos entre sÃ­. En este caso, es imprescindible usar la misma escala en todas las facetas. Para ello, hay que especificar los lÃ­mites de las escalas de los ejes.

Â¿Existe una forma fÃ¡cil de saber cuÃ¡les poner? Claro, con un `summary()` de las variables, tal como indicamos a continuaciÃ³n, vemos rÃ¡pidamente el valor mÃ­nimo y mÃ¡ximo de las variables que nos interesan:


ğŸ¦„ **Paso 9 ** Mejoramos la escala para comparar facetas: observamos los lÃ­mites de las variables.
```{r}
summary(demog_data$Life_expectancy)
summary(demog_data$Growth_rate)
```


ğŸ¦„ **Paso 10** Especificamos los lÃ­mites en los 
```{r}
demog_scatter_escala <- ggplot(data = demog_data,
                               aes(x = Growth_rate,
                                   y = Life_expectancy,
                                   colour = Continent)) +
  geom_point(alpha = 0.5) +
  facet_wrap(~ Continent, scales = "free") +
  labs(title = "Esperanza de vida respecto al PIB per capita",
       x = "Tasa de crecimiento", y = "Esperanza de vida",
       colour = "Continent") +
  scale_x_continuous(limits = c(-10, 45)) +
  scale_y_continuous(limits = c(45, 85)) +
  theme_light()

demog_scatter_escala 
```



ğŸ“ˆ **Linea de suavizado**

A veces, si hay una tendencia evidente, es conveniente usar una lÃ­nea de suavizado que la identifique. En este caso, no estÃ¡ nada clara, por lo que la podemos omitir. Y aquÃ­ sÃ­ es interesante dejar libre la escala, para maximizar la visualizaciÃ³n de la tendencia, que es lo que nos interesa.

**Paso 11**  AÃ±adimos lÃ­nea de suavizado con la funciÃ³n `geom_smooth()`.

```{r}
#| eval: false
______ + geom_smooth(method = NULL, se = TRUE) 
```


::: {.callout-tip}
## CÃ³mo narrar una historia convincente con tus datos.

Hemos visto el **planteamiento**, en el que proporcionamos el contexto: trabajamos para un jefe que nos ha pedido algo muy concreto: un anÃ¡lisis exploratorio (y sabemos que lo quiere con conclusiones)...

El anÃ¡lisis exploratorio podemos usarlo para ir introduciendo la **trama**, donde vemos enseguida relaciones interesantes entre algunas parejas de variables... Solo hemos analizado la esperanza de vida al nacer respecto a la tasa de crecimiento, pero en la matriz de puntos hemos visto muchas, por lo que el jefe estarÃ¡ feliz.

La segmentaciÃ³n tambiÃ©n nos ha proporcionado agrupaciones de paÃ­ses, aunque visualmente son difÃ­ciles de interpretar, por lo que lo mÃ¡s lÃ³gico serÃ­a seleccionar un conjunto de paÃ­ses de interÃ©s, que consiga un anÃ¡lisis (y su visualizaciÃ³n) mÃ¡s interesante.

Como siempre, lo mÃ¡s importante es el **desenlace**, donde le estamos dando a nuestro jefe las claves que necesita:

-   La matriz de puntos es vital, si nuestro superior estÃ¡ habituado al anÃ¡lisis, porque **se aprecia un nÃºmero importante de relaciones claras entre variables**.

-   En cada variable **podemos usar la estÃ©tica y las facetas para potenciar la visualizaciÃ³n**, determinando las variables que suministran informaciÃ³n en las relaciones encontradas.

Finalmente, hemos visto que, cuando tenemos un nÃºmero elevado de informaciÃ³n, tenemos que adoptar una decisiÃ³n equilibrada entre la informaciÃ³n que suministramos en nuestros grÃ¡ficos y nuestra habilidad para eliminar el desorden y enfocar la mirada del espectador a lo que nos interesa mÃ¡s. Para el caso que nos ocupa, podemos:

-   Usar la agrupaciÃ³n previa por zonas geogrÃ¡ficas, como hemos hecho antes.

-   Restringir la visualizaciÃ³n a una zona geogrÃ¡fica concreta.

-   Filtrar determinados paÃ­ses para quedarnos con los que nos interesa comparar.

-   Directamente usar una tabla, relacionando todos los paÃ­ses de interÃ©s.
:::

![](img/logos_finan.png){align="right"}
