{
  "hash": "540b94bfce0ea2660168c399b764119f",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"¿Dónde se ha sufrido más la borrasca Filomena?\"\nauthor:\n  - Gema Fernández-Avilés (Gema.FAviles@uclm.es)\n  - Isidro Hidalgo (Isidro.Hidalgo@uclm.es)\nformat:\n  html:\n    theme: cerulean\n    highlight-style: ayu-mirage\n    self-contained: true\n    date: \"2025-01-11\"\n    embed-resources: true\n    toc-title: Summary\n    toc: true\n    number-sections: true\n    preview-links: auto\n    code-link: true\n    code-fold: true\nnumber-sections: true\nexecute:\n  echo: true\n  eval: true\n  output: true\n  include: true\n  freeze: auto\n  fig-height: 5\n  warning: false\n  comment: \"#>\"\n  code-line-numbers: true\n  code-copy: true\n  code-overflow: scroll\n  code-fold: true\n---\n\n\n\n::: {.callout-note}\nLos datos que se utilizan en esta historia están disponibles en el paquete `CDR` que puede instalarse con el siguiente comando (se comprueba si no lo está):\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Instalación y/o carga del paquete `CDR`\"}\nif (!require(CDR)){\n  if (!require(remotes)) {install.packages(\"remotes\")}\n  remotes::install_github(\"cdr-book/CDR\")\n  }\n```\n:::\n\n\n\nLos datos referentes a la temperatura en España han sido recopilados por la Agencia Estatal de Meteorología (AEMET) y descargados en **R** con el paquete climatológico `climaemet`. Los mapas de España han sido procesados con el paquete `mapSpain`.\n:::\n\n# \"¿Dónde se `ha sufrido` más la borrasca Filomena?\"\n\nEl director de informativos de RTVE nos ha pedido al equipo de visualización que le preparemos un mapa rebonico para Informe Semanal. Como siempre, de un día para otro... ¡Que estamos a viernes por la tarde y ya me iba a ir a casica, con mi batica de Albacete! Que ya se sabe: \"¡Pijama y bata... calefacción barata!\".\n\n# Entender el contexto\n\n::: {.callout-tip}\n## Cómo definir el propósito y la audiencia de tu análisis\n\nEn este caso, está muy claro lo que nos piden: un mapa de España donde se pueda valorar fácilmente dónde ha sido más intensa la borrasca, por lo que directamente vamos a ir a visualizaciones basadas en el paquete `sf`, que nos permite usar geoestadística al más alto nivel y representar cualquier fenómeno espacialmente.\n\nComo siempre, vamos a empezar por explorar un poco los datos y después finalizaremos con la visualización espacial.\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Configuración inicial y datos\"}\nlibrary(CDR)\nlibrary(tidyverse)\nlibrary(mapSpain)\nlibrary(sf)\nlibrary(GGally)\nlibrary(NbClust)\nlibrary(igraph)\nlibrary(factoextra)\nlibrary(corrplot)\nlibrary(explore)\n\nesp <- esp_get_ccaa() |>\n  filter(ine.ccaa.name != \"Canarias\") # Filtramos las Islas Canarias\n\nhead(tempmin_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       fecha indicativo tmin  longitud  latitud\n1 2021-01-06      4358X -4.7 -5.880556 38.95556\n2 2021-01-06      4220X -7.0 -4.616389 39.08861\n3 2021-01-06      6106X  4.7 -4.748333 37.02944\n4 2021-01-06      9698U -6.8  0.865278 42.20528\n5 2021-01-06      4410X -3.4 -6.385556 38.91583\n6 2021-01-06      1331A  1.0 -7.031389 43.52472\n```\n\n\n:::\n\n```{.r .cell-code  code-summary=\"Configuración inicial y datos\"}\ntmin_sf <- st_as_sf(tempmin_data, coords = c(\"longitud\", \"latitud\"), crs = 4326)\n\n# Verificamos que los sistemas de coordenadas de la capa de mapas de España (paquete `mapspain`) y de la capa de temperaturas mínimas (paquete `CDR`) sean los mismos; si no lo son, transformamos uno para igualarlos.\nif (st_crs(tmin_sf) != st_crs(esp)) {\n  esp <- st_transform(esp, st_crs(tmin_sf))\n}\n```\n:::\n\n\n\n# Elegir una visualización adecuada\n\n::: {.callout-tip}\n## Selección de gráficos y visualizaciones que mejor representen tus datos.\n:::\n\n# ¿Gráfico de cajas o de violines?\n\nAmbas soluciones son ideales para ver la distribución de las temperaturas mínimas. Recomendamos los violines porque son más informativos, ya que se ve mejor la distribución de las variables cuantitativas.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(tempmin_data, aes(x = fecha, y = tmin)) +\n  geom_boxplot(fill = \"orange\", alpha = 0.6)\n```\n\n::: {.cell-output-display}\n![](hist5_filomena_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n:::\n\n\n\n## Mejora tu visualización con las herramientas disponibles\n\n¿como podemos mejorar esta visualización? Ya hemos visto algunas:\n\n-   gráficos de violines\n\n-   título y subtítulo declarativos\n\n-   estética: color, anotaciones\n\nY por encima de todo: ¡simplicidad!\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboxplot_inicial <- ggplot(tempmin_data,\n                          aes(x = fecha, y = tmin)) +\n  geom_violin(color = \"orange\") +\n  geom_boxplot(alpha = 0.6, fill = \"orange\") +\n  labs(title = \"La borrasca Filomena fue más intensa el 6 de enero\",\n       x = \"Fecha\", y = \"Temperatura mínima (°C)\") +\n  theme_minimal() +\n  theme(axis.title.x = element_text(hjust = 0),\n        axis.title.y = element_text(hjust = 1))\n\nboxplot_inicial\n```\n\n::: {.cell-output-display}\n![](hist5_filomena_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n## Simplificación\n\nBasta una primera mirada al gráfico para darnos cuenta de que las dos visualizaciones (caja y violín) aportan conjuntamente demasiada información. Por tanto, eliminamos elementos innecesarios del gráfico para enfocar la atención en lo que queremos destacar.\n\nPor eso, calculamos la mediana de las temperaturas y las conectamos temporalmente mediante un gráfico de línea, de forma que podamos indicar, no solo la distribución de la variable, sino también su evolución:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmedianas <- tempmin_data |>\n  select(fecha, tmin) |>\n  group_by(fecha) |>\n  mutate(mediana = median(tmin)) |>\n  select(fecha, mediana) |>\n  unique()\nmedianas$pos <- 1:5\n\nboxplot_inicial <- ggplot(tempmin_data,\n                          aes(x = fecha, y = tmin)) +\n  geom_violin(color = \"orange\", fill = \"orange\", alpha = .7) +\n  geom_point(data = medianas, aes(x = fecha, y = mediana),\n             color = \"darkblue\") +\n  geom_line(data = medianas, aes(x = pos, y = mediana),\n            color = \"darkblue\") +\n  labs(title = \"Temperaturas mínimas durante la borrasca Filomena\",\n       subtitle = \"La borrasca fue más intensa el 6 de enero en la mayoría de estaciones (mediana en color azul)\",\n       x = \"Fecha\", y = \"Temperatura mínima (°C)\") +\n  theme_minimal() +\n  theme(axis.title.x = element_text(hjust = 0),\n        axis.title.y = element_text(hjust = 1))\n\nboxplot_inicial\n```\n\n::: {.cell-output-display}\n![](hist5_filomena_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\nAquí podríamos añadir los valores sobre el violín. En algunos casos, como cuando hay colas muy largas (aquí la inferior del día 7) es interesante ver si se debe a pocos valores o, por el contrario, hay que tenerlos en cuenta. Vamos a verlo:\n\n\n::: {.callout-important title=\"Tu turno\"}\nCompleta las partes del código señaladas por `_____` o `xxxxx` para obtener el resultado propuesto. ¿Te acuerdas de las funciones para explorar todas las variables a la vez?\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmedianas <- tempmin_data |>\n  select(fecha, tmin) |>\n  group_by(fecha) |>\n  mutate(mediana = median(______)) |>\n  select(fecha, mediana) |>\n  unique()\nmedianas$pos <- 1:5\n\nboxplot_inicial <- ggplot(tempmin_data,\n                          aes(x = fecha, y = tmin)) +\n  geom_violin(color = \"orange\", fill = \"orange\", alpha = .7) +\n  geom_point(data = medianas, aes(x = fecha, y = _______),\n             color = \"darkblue\") +\n  geom_XXXX(data = medianas, aes(x = pos, y = mediana),\n            color = \"darkblue\") +\n  geom_jitter(size = .2, width = .2) +\n  labs(title = \"Temperaturas mínimas durante la borrasca Filomena\",\n       ________ = \"La borrasca fue más intensa el 6 de enero en la mayoría de estaciones (mediana en color azul)\",\n       x = \"Fecha\", y = \"Temperatura mínima (°C)\") +\n  theme_minimal() +\n  theme(axis.title.x = element_text(hjust = 0),\n        axis.title.y = element_text(hjust = 1))\n\nboxplot_inicial\n```\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](hist5_filomena_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n:::\n\n\n\nSe ve claramente que las colas de los días 7 y 8 se deben casi exclusivamente a una estación, por lo que nuestra conclusión (y la que refleja la mediana) de etiquetar el día 6 como el peor, es acertada.\n\n::: {.callout-tip}\nCUIDADO: es importante usar el argumento `size` en la función `geom_jitter` para hacer lo suficientemente pequeños los puntos y que no \"molesten\". Si se deja el valor por defecto (`size = 1`) aumentamos mucho el desorden.\n:::\n\n# Visualizaciones espaciales\n\nEn visualización, usando técnicas espaciales tenemos claramente las de ganar, porque tienen una estética muy atractiva *per se*.\n\nPuesto que el día de mayor intensidad general fue el 6 de enero, vamos a trabajar con esas temperaturas mínimas, representándolas en un mapa para ver las zonas más afectadas.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntmin_6enero <- tmin_sf |> \n  filter(fecha == \"2021-01-06\")\n\nmapa_inicial <- ggplot() +\n  geom_sf(data = esp, fill = \"grey95\") +\n  geom_sf(data = tmin_6enero, aes(color = tmin)) +\n  theme_dark()\n\nmapa_inicial \n```\n\n::: {.cell-output-display}\n![](hist5_filomena_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n::: {#exr-1}\n¿Qué podríamos hacer para mejorar esta visualización?\n:::\n\nAlgunas cosas que se pueden hacer:\n\n-   añadir un título (y subtítulo) declarativo interesante\n\n-   eliminar distracciones (por ejemplo el fondo)\n\n-   aumentar el tamaño de los puntos para que se aprecie mejor la gama de colores de la escala\n\n-   mejorar directamente los colores de la escala, para que se aprecien bien las diferencias\n\n::: {.callout-important title=\"Tu turno\"}\nCompleta las partes del código señaladas por `_____` o `xxxxx` para obtener el resultado propuesto.\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = esp, fill = \"grey95\") +\n  geom_sf(data = _________, aes(color = tmin), size = 3, alpha = 0.7) +\n  theme_dark() +\n  labs(title = \"__________\",\n       _______ = \"Borrasca Filomena\",\n       color = \"Temp. mínima (°C)\")\n```\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](hist5_filomena_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nmapa_final <- ggplot() +\n  geom_xx(data = esp, fill = \"grey95\") +\n  geom_xx(data = ____________, aes(color = tmin), size = 3, alpha = 0.7) +\n  labs(title = \"Temperaturas mínimas durante la borrasca Filomena (6 de enero de 2021)\",\n       subtitle = \"Las temperaturas mínimas fueron más bajas en la España interior y zonas de montaña\",\n       color = \"Temperatuta mínima (°C)\") +\n  scale_color_XXXXXXX_c() +\n  theme_minimal() +\n    theme(axis.title.x = element_text(hjust = 0),\n        axis.title.y = element_text(hjust = 1))\n\nmapa_final\n```\n:::\n\n\n\n### ¿Añadimos la dimensión temporal?\n\nPodemos empezar por usar facetas según el día en los que transcurrió la borrasca. Vamos a verlo.\n\n::: {.callout-important title=\"Tu turno\"}\nCompleta las partes del código señaladas por `_____` o `xxxxx` para obtener el resultado propuesto.\n:::\n\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](hist5_filomena_files/figure-html/unnamed-chunk-12-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot() +\n  geom_sf(data = esp, fill = \"grey95\") +\n  geom_sf(data = tmin_sf, aes(color = tmin), size = 3, alpha = 0.7) +\n  facet_xxx(vars(fecha), ncol = 3) +\n  scale_color_xxxxxx() +\n  theme_light() +\n  labs(title = \"Temperaturas mínimas en España durante Filomena\",\n       subtitle = \"Del 6 al 10 de enero de 2021\",\n       color = \"Temp. mínima (°C)\") +\n  theme(legend.position = \"_______\")\n```\n:::\n\n\n\n::: {.callout-tip}\n¿Qué os parece?¿Añade información interesante la dimensión temporal? ¿Y usando otra escala más acorde con nuestra idea de frío y calor?\n:::\n\nFijémonos lo que se puede hacer con una buena elección de escala. ¿Mejora la claridad y el impacto visual? ¿Se aprecian las diferencias temporales?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# echo: false\ncortes <- c(-Inf, seq(-20, 20, 2.5), Inf)\ncolores <- hcl.colors(15, \"PuOr\", rev = TRUE)\n\nggplot() +\n  geom_sf(data = esp, fill = \"grey95\") +\n  geom_sf(data = tmin_sf, aes(color = tmin), size = 3, alpha = 0.7) +\n  facet_wrap(vars(fecha), ncol = 3) +\n  scale_color_gradientn(colours = colores, breaks = cortes, \n                        labels = ~ stringr::str_c(. , \"º\"), \n                        guide = \"legend\") +\n  theme_light() +\n  labs(title = \"Temperaturas mínimas en España durante Filomena\",\n       subtitle = \"Del 6 al 10 de enero de 2021\",\n       color = \"Temp. mínima (°C)\")\n```\n\n::: {.cell-output-display}\n![](hist5_filomena_files/figure-html/unnamed-chunk-14-1.png){width=672}\n:::\n:::\n\n\n\n# Contar una historia\n\n::: {.callout-tip}\n## Cómo narrar una historia convincente con tus datos.\n\nHemos visto el **planteamiento**, en el que proporcionamos el contexto: trabajamos para el director de informativos de RTVE, que nos ha pedido un mapa para presentarlo en las noticias.\n\nEl análisis exploratorio nos da una idea: el día más frío durante la borrasca Filomena fue el 6 de enero, por lo que ya tenemos qué información interesante podemos destacar.\n\nPero como remarcamos siempre, lo más importante es el **desenlace**, donde le estamos dando a nuestro director lo que nos pide:\n\n-   Un mapa donde se aprecia el **diferente impacto de la borrasca según la zona de España**...\n\n-   ...introduciendo la **dimensión temporal** con facetas.\n\n:::\n\n# Para pensar:\n\n::: {.callout}\nEn esta historia hemos visto lo importante que puede ser la **elección de una buena escala de colores**. Merece mucho la pena dedicar tiempo a la escala (intervalos y gama de colores), ya que, especialmente cuando hay gradientes continuos convertibles en categorías discretas, puede suponer acertar con la visualización o perder una buena oportunidad.\n:::\n\n\n",
    "supporting": [
      "hist5_filomena_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}