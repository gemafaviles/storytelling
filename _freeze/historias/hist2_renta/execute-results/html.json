{
  "hash": "c2475ec5f9ba817e0a9ae56944f6211c",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"¿Qué pasa con la renta municipal?\"\nauthor:\n  - Gema Fernández-Avilés (Gema.FAviles@uclm.es)\n  - Isidro Hidalgo (Isidro.Hidalgo@uclm.es)\nformat: html\ntheme: cerulean\nhighlight-style: ayu-mirage\nself-contained: true\ndate: \"2024-12-28\"\ncode-link: true\nnumber-sections: true\nexecute:\n  code-overflow: scroll\n  echo: true\n  eval: true\n  output: true\n  include: true\n  freeze: auto\n  fig-height: 5\n  warning: false\n  code-fold: true\n  comment: \"#>\"\n  code-line-numbers: true\n  code-copy: true\n#bibliography: biblio.bib\n---\n\n\n\n\n# ¿Qué pasa con la renta municipal en España antes de la pandemia de coronavirus?\n\nTrabajo en una compañía privada que quiere introducir un producto de alta gama, y me ha pedido el jefe que le haga un informe sobre la renta municipal en España de los últimos años, porque el CEO quiere ampliar el mercado a determinados tramos de renta, y necesita localizar caladeros de negocio. Me ha dicho que los datos los puedo sacar del paquete `CDR`. También me ha dicho que están limpios, pero no me fío.\n\n## Contexto\n\n¿Por qué es importante? Porque no da lo mismo analizar la renta como administración que como empresario que busca oportunidades de negocio. En el primer caso, se busca entender la distribución de la renta para poder diseñar políticas públicas que reduzcan la desigualdad. Probablemente, no estamos tan interesados en los municipios más ricos, sino en los más desiguales. Pero como somos gente de empresa, buscamos identificar segmentos de mercado con capacidad de compra para ofrecer un producto, por lo que nos interesa saber dónde vive la gente con más dinero.\n\nEn cualquiera de los dos casos, lo primero es hacer un análisis exploratorio para ver si hay algo raro en los datos y analizar mínimamente las variables de interés. Y después, le vamos a preparar al jefe un par de gráficos para que vea que soy un crack **aportándole conocimiento**.\n\n\n::: {.callout-note}\nLos datos que se utilizan en esta historia están disponibles en el paquete `CDR`\nque puede instalarse con el siguiente comando:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nif (!require(CDR)){\n  if (!require(remotes)) {install.packages(\"remotes\")}\n  remotes::install_github(\"cdr-book/CDR\")\n}\n```\n:::\n\n\n\nRenta Neta per cápita por municipios (en euros), distritos y secciones censales. Esta información se ha extraído del Atlas de distribución de renta de los hogares proporcionado por el Instituno Nacional de Estadística y ha sido procesada para faciliar el análisis.\n\n:::\n\n\nUn poco de información básica sobre los datos cargados:\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(renta_municipio_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n                           Unidad  2019  2018  2017 2016 2015 codigo_ine\n1                    44001 Ababuj    NA    NA    NA   NA   NA      44001\n2      4400101 Ababuj distrito 01    NA    NA    NA   NA   NA    4400101\n3 4400101001 Ababuj sección 01001    NA    NA    NA   NA   NA 4400101001\n4                    40001 Abades 11429 10731 10314 9816 9904      40001\n5      4000101 Abades distrito 01 11429 10731 10314 9816 9904    4000101\n6 4000101001 Abades sección 01001 11429 10731 10314 9816 9904 4000101001\n```\n\n\n:::\n\n```{.r .cell-code}\nhelp(renta_municipio_data)\nstr(renta_municipio_data)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n'data.frame':\t55273 obs. of  7 variables:\n $ Unidad    : chr  \"44001 Ababuj\" \"4400101 Ababuj distrito 01\" \"4400101001 Ababuj sección 01001\" \"40001 Abades\" ...\n $ 2019      : int  NA NA NA 11429 11429 11429 8954 8954 8954 10791 ...\n $ 2018      : int  NA NA NA 10731 10731 10731 8589 8589 8589 10258 ...\n $ 2017      : int  NA NA NA 10314 10314 10314 8207 8207 8207 9762 ...\n $ 2016      : int  NA NA NA 9816 9816 9816 7671 7671 7671 9478 ...\n $ 2015      : int  NA NA NA 9904 9904 9904 8416 8416 8416 9116 ...\n $ codigo_ine: chr  \"44001\" \"4400101\" \"4400101001\" \"40001\" ...\n```\n\n\n:::\n:::\n\n\n\nVemos que hay mezcla de secciones censales y municipios. Vamos a quedarnos solo con los municipios (ya sabía yo que habría que hacer un poco de limpieza)...\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nrenta_municipio_data <- renta_municipio_data[substr(\n  renta_municipio_data$Unidad, 6, 6) == \" \",\n]\n```\n:::\n\n\n\n::: {#exr-1}\n\n¿Que hacemos con los datos faltantes? En este análisis eliminarlos.\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nrenta <- renta_municipio_data |>\n   drop_na()\n\nhead(renta)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n          Unidad  2019  2018  2017  2016  2015 codigo_ine\n1   40001 Abades 11429 10731 10314  9816  9904      40001\n2   10001 Abadía  8954  8589  8207  7671  8416      10001\n3   27001 Abadín 10791 10258  9762  9478  9116      27001\n4  48001 Abadiño 15575 14975 14724 14515 13919      48001\n5   26001 Ábalos 11910 11153  9552 10651 10775      26001\n6 30001 Abanilla  9860  9415  9044  8444  8274      30001\n```\n\n\n:::\n:::\n\n\n\n¡Esto ya es otra cosa! Ahora sí que podemos empezar a trabajar con datos limpios (los ingleses les llaman \"tidy data\").\n\n## Análisis exploratorio de la renta municipal en España\n\n::: {#exr-2}\n\n¿Cuál es la renta per cápita media de los municipios españoles en 2019?\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(renta$`2019`)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n   5898    9995   11428   11611   12930   26367 \n```\n\n\n:::\n:::\n\n\n\n\n::: {#exr-2}\n\n¿Es la renta media la misma en todos los municipios?\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(\"summarytools\")\nrenta |>\n  select(`2019`) |>\n  descr()\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nDescriptive Statistics  \n2019  \nN: 6424  \n\n                        2019\n----------------- ----------\n             Mean   11611.25\n          Std.Dev    2211.72\n              Min    5898.00\n               Q1    9994.50\n           Median   11427.50\n               Q3   12930.00\n              Max   26367.00\n              MAD    2173.49\n              IQR    2934.75\n               CV       0.19\n         Skewness       0.77\n      SE.Skewness       0.03\n         Kurtosis       1.33\n          N.Valid    6424.00\n        Pct.Valid     100.00\n```\n\n\n:::\n:::\n\n\n\n\n¡Qué lio! Mejor un gráfico que una tabla (J. Tukey)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = renta, aes(x=`2019`)) +\n  geom_histogram() #30 bins por defecto\n```\n\n::: {.cell-output-display}\n![](hist2_renta_files/figure-html/renta-hist-1.png){width=672}\n:::\n:::\n\n\n\n¡Qué histograma más feo! Vamos a mejorarlo\n\n::: {.callout-important title=\"Tu turno\"}\n\nCompleta las partes del código señaladas por `______` o `xxx` para obtener el resultado propuesto.\n:::\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np_renta_2019 <- ggplot(renta, aes(`2019`)) +\n  geom_xxxxxx(col = \"darkred\",\n                 fill = \"bisque\", \n                 bins = nclass.Sturges(renta_municipio_data$`2019`)) +\n  geom_xxxxxx(aes(xintercept = mean(`2019`)),\n             color = \"red\",\n             linetype = \"dashed\",\n             linewidth = 1) +\n  geom_xxxxxx(aes(x = mean(`2019`),\n                y = 100,\n                label = round(mean(`2019`), 2)),\n            color = \"darkred\") +\n  labs(title = \"Distribución de la renta por municipios\",\n       x = \"Renta per cápita\",\n       y = \"Frecuencia\") +\n  theme_xxxxxx()\n\np_renta_2019 \n```\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](hist2_renta_files/figure-html/renta-hist-beauty-1.png){width=672}\n:::\n:::\n\n\n\n\n::: {#exr-2}\n\n¿Sería mejor tener un gráfico de densidad? ¿Cómo se interpretaría?\n¿Qué diferencias hay respecto al histograma?\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np_renta_2019_density <- ggplot(renta, aes(`2019`)) +\n  geom_density(fill = \"bisque\",\n               alpha= 0.4,\n               color=\"darkred\",\n               lwd = 1) +\n  geom_vline(aes(xintercept = mean(`2019`)),\n             color = \"red\",\n             lwd = 1,\n             linetype = \"dashed\") +\n  geom_text(aes(x = mean(`2019`),\n                y = 0.00001,\n                label = round(mean(`2019`), 2)),\n            color = \"darkred\") +\n  labs(title = \"Distribución de la renta por municipios\",\n       x = \"Renta per cápita\",\n       y = \"Densidad\") +\n  theme_minimal()\n\np_renta_2019_density\n```\n\n::: {.cell-output-display}\n![](hist2_renta_files/figure-html/renta-density-1.png){width=672}\n:::\n:::\n\n\n\n\n::: {#exr-2}\n\n¿Cuál me gusta más? ¿Histograma o densidad? ¿Juntos?\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np_renta_2019_density + \n  geom_histogram(aes(y=..density..),\n                 fill = \"bisque\",\n                 color=\"darkred\",\n                 alpha = 0.4)\n```\n\n::: {.cell-output-display}\n![](hist2_renta_files/figure-html/renta-density2-1.png){width=672}\n:::\n:::\n\n\n\n\n::: {#exr-2}\n\n¿Por qué no tener un 5-summary plot? ¿Qué nos dice?\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np <- renta |>\n  ggplot(aes(x=0, y= `2019`)) \n\nboxplot <- p + \n  geom_boxplot(color = \"darkred\", fill = \"bisque\") +\n  theme_minimal()\n\nviolin <- p + geom_violin(color = \"darkred\", fill = \"bisque\") +\n  theme_minimal()\n\nlibrary(patchwork)\nboxplot + violin\n```\n\n::: {.cell-output-display}\n![](hist2_renta_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n\n::: {#exr-2}\n\n¿En los años anteriores la renta ha sido similar?\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np <- renta |>\n  ggplot(aes(x=0, y= `2015`))\n\np + geom_violin( ) +\n     geom_violin(aes(fill = \"2015\")) +\n     geom_violin(aes(x=1, y= `2016`, fill = \"2016\")) +\n     geom_violin(aes(x=2, y= `2017`, fill = \"2017\")) +\n     geom_violin(aes(x=3, y= `2018`, fill = \"2018\")) +\n     geom_violin(aes(x=4, y= `2019`, fill = \"2019\")) +\n  # añade la media de cada año al violín\n  geom_point(aes(x=0, y=mean(`2015`)), color = \"red\") +\n  geom_point(aes(x=1, y=mean(`2016`)), color = \"red\") +\n  geom_point(aes(x=2, y=mean(`2017`)), color = \"red\") +\n  geom_point(aes(x=3, y=mean(`2018`)), color = \"red\") +\n  geom_point(aes(x=4, y=mean(`2019`)), color = \"red\") +\n  theme_minimal() +\n    scale_x_continuous(breaks = c(0, 1, 2, 3, 4),\n                       labels = c(\"2015\", \"2016\", \"2017\", \"2018\", \"2019\")) +\n     labs(title = \"Distribución de la renta por municipios\",\n          x = \"Año\",\n          y = \"Renta per cápita (euros)\")\n```\n\n::: {.cell-output-display}\n![](hist2_renta_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n\n::: {#exr-2}\n\n¿Es necesario el color? ¿Queremos ver también la evolución a lo largo del tiempo? Pues quizá podemos matar dos pájaros de un tiro... veamos...\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmedias <- renta |>\n  summarise(across(`2015`:`2019`, mean, na.rm = TRUE)) |>\n  pivot_longer(cols = `2015`:`2019`,\n               names_to = \"pos\",\n               values_to = \"renta\") |>\n  mutate(pos = as.numeric(pos) - 2015)\np <- renta |>\n  ggplot(aes(x=0, y= `2015`))\n\np + geom_violin( ) +\n  geom_violin(aes(x=0, y= `2015`), fill = \"bisque\", col = \"transparent\") +\n  geom_violin(aes(x=1, y= `2016`), fill = \"bisque\", col = \"transparent\") +\n  geom_violin(aes(x=2, y= `2017`), fill = \"bisque\", col = \"transparent\") +\n  geom_violin(aes(x=3, y= `2018`), fill = \"bisque\", col = \"transparent\") +\n  geom_violin(aes(x=4, y= `2019`), fill = \"bisque\", col = \"transparent\") +\n  # añade la media de cada año al violín\n  geom_point(aes(x=0, y=mean(`2015`)), color = \"darkred\") +\n  geom_point(aes(x=1, y=mean(`2016`)), color = \"darkred\") +\n  geom_point(aes(x=2, y=mean(`2017`)), color = \"darkred\") +\n  geom_point(aes(x=3, y=mean(`2018`)), color = \"darkred\") +\n  geom_point(aes(x=4, y=mean(`2019`)), color = \"darkred\") +\n  # añade la línea de tendencia uniendo las medias\n  geom_line(data = medias,\n            aes(x = pos,\n                y = renta,\n                group = 1),\n            color = \"darkred\") +\n  theme_minimal() +\n  scale_x_continuous(breaks = c(0, 1, 2, 3, 4),\n                     labels = c(\"2015\", \"2016\", \"2017\", \"2018\", \"2019\")) +\n  labs(title = \"Distribución de la renta por municipios entre 2015 y 2019\",\n       x = \"Año\",\n       y = \"Renta per cápita (euros)\")\n```\n\n::: {.cell-output-display}\n![](hist2_renta_files/figure-html/unnamed-chunk-6-1.png){width=672}\n:::\n:::\n\n\n\n\n::: {#exr-2}\n\n¿Son los municipios de norte más ricos que los del sur de España en 2019?\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(\"sf\")\nhelp(municipios)\n\nmunis_renta <- municipios |>\n  left_join(renta) |>   # une datasets\n  select(name, cpro, ine.prov.name, cmun,\n       `2015`,`2016`,`2017`,`2018`,`2019`) # selecciona variables\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(munis_renta) +\n  geom_sf(aes(fill = `2019`), color = NA) +\n  scale_fill_continuous(labels = scales::label_number(big.mark = \".\",\n                                                      decimal.mark = \",\",\n                                                      suffix = \" €\" )) +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](hist2_renta_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n\n## Que no nos mientan con la estadística (ni con la visualización)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmunis_renta_clean <- munis_renta |>\n  filter(!is.na(`2019`))\n\n# crea Fisher-Jenks clases\nlibrary(classInt)\nfisher <- classIntervals(munis_renta_clean$`2019`,\n                         style = \"fisher\",\n                         n = 10)\nggplot(munis_renta_clean) +\n  geom_sf(aes(fill = cut(`2019`, fisher$brks)), color = NA) +\n  scale_fill_viridis_d(option= \"A\",\n                       labels= scales::label_number(suffix= \"€\")) +\n  guides(fill = guide_colorsteps()) +\n  labs(fill= \"Fisher-Jenks\") +\n  theme_minimal()\n```\n\n::: {.cell-output-display}\n![](hist2_renta_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\n::: {#exr-2}\n\n¿Cuál es la provincia con mayor renta media municiapal en 2019? ¿Y la que menos renta media tiene?\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmunis_renta |>\n  ggplot(aes(x = `2019`, y = ine.prov.name, color = cpro)) +\n  geom_point() +\n  labs(title = \"Renta per cápita por provincia en 2019\",\n       x = \"Renta per cápita\",\n       y = \"Provincia\") +\n  theme_minimal() +\n  theme(legend.position = \"none\")\n```\n\n::: {.cell-output-display}\n![](hist2_renta_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\nMejor los ordenamos las provincias. Y de nuevo, ¿nos aporta el color?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmunis_renta2 <- munis_renta |>\n  group_by(ine.prov.name) |>\n  summarise(pro2019 = mean(`2019`, na.rm = TRUE)) |>\n  arrange(desc(pro2019)) |>\n  st_drop_geometry() |>\n  filter(!is.na(pro2019))\nmunis_renta2_plot <- ggplot(munis_renta2, aes(y = pro2019,\n                         x = reorder(ine.prov.name, pro2019)),\n                         color = \"darkred\") +\n  geom_segment(aes(x= reorder(ine.prov.name, pro2019),\n                   xend = reorder(ine.prov.name, pro2019),\n                   y = 0,\n                   yend = pro2019),\n               color =\"darkred\") +\n  geom_point() +\n  coord_flip() +\n  labs(title = \"Renta per cápita por provincia en 2019\",\n       x = \"Renta per cápita\",\n       y = \"Provincia\") +\n  theme_minimal()\nmunis_renta2_plot\n```\n\n::: {.cell-output-display}\n![](hist2_renta_files/figure-html/unnamed-chunk-11-1.png){width=672}\n:::\n:::\n",
    "supporting": [
      "hist2_renta_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}