{
  "hash": "9afb4dd08a956f3879dd6782e55d6699",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"¿Quién sobrevivió al Titanic?\"\nauthor:\n  - Gema Fernández-Avilés (Gema.FAviles@uclm.es)\n  - Isidro Hidalgo (Isidro.Hidalgo@uclm.es)\nformat:\n  html:\n    theme: cerulean\n    highlight-style: ayu-mirage\n    self-contained: true\n    lang: es\n    date: 01/16/2025\n    date-format: long\n    embed-resources: true\n    toc-title: Summary\n    toc: true\n    number-sections: true\n    preview-links: auto\n    code-link: true\n    code-fold: true\nnumber-sections: true\nexecute:\n  echo: true\n  eval: true\n  output: true\n  include: true\n  freeze: auto\n  fig-height: 5\n  warning: false\n  comment: \"#>\"\n  code-line-numbers: true\n  code-copy: true\n  code-overflow: scroll\n  code-fold: true\n---\n\n\n\n::: {.callout-note}\nLos datos para esta historia están sacados de la competición de kaggle \"Titanic - Machine Learning from Disaster\": https://www.kaggle.com/competitions/titanic. Los datasets de entrenamiento y test se encuentran en el objeto `titanic` del paquete `titanic`.\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Instalación y/o carga del paquete `titanic`\"}\nif (!require(titanic)){install.packedads(\"titanic\")}\n```\n:::\n\n\n:::\n\n# ¿Quién sobrevivió al Titanic?\n\nMi colega de departamento se ha picado con el departamento vecino, y se han apostado que ganaban el próximo datathon de GAIA-X. No pasaría nada, sería su problema, si no me hubiera pedido que le ayudara con el análisis exploratorio, que está mal de tiempo... lo de siempre... ¡¿Pero por qué no pueden dejarme tranquilo?!\n\n# Entender el contexto\n\n::: {.callout-tip}\n\n## Cómo definir el propósito y la audiencia de tu análisis\n\nEn este caso, puesto que el objetivo de mi colega es la predicción, lo primero que vamos a hacer es un análisis exploratorio, para ver las relaciones entre las variables del conjunto de datos. Luego ya se apañará mi compañero para modelizar... ¡a ver si se piensa que lo voy a hacer todo yo!\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Configuración inicial y datos\"}\nlibrary(titanic)\nlibrary(tidyverse)\nlibrary(skimr)\nlibrary(explore)\nlibrary(caret)\nlibrary(ggmosaic)\nlibrary(ggalluvial)\nlibrary(pROC)\nlibrary(visdat)\n\ntitanic <- titanic_train\nnames(titanic)[1:6] <- c(\"id\", \"supervivencia\", \"clase\", \"nombre\", \"sexo\", \"edad\")\nhead(titanic)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  id supervivencia clase                                              nombre\n1  1             0     3                             Braund, Mr. Owen Harris\n2  2             1     1 Cumings, Mrs. John Bradley (Florence Briggs Thayer)\n3  3             1     3                              Heikkinen, Miss. Laina\n4  4             1     1        Futrelle, Mrs. Jacques Heath (Lily May Peel)\n5  5             0     3                            Allen, Mr. William Henry\n6  6             0     3                                    Moran, Mr. James\n    sexo edad SibSp Parch           Ticket    Fare Cabin Embarked\n1   male   22     1     0        A/5 21171  7.2500              S\n2 female   38     1     0         PC 17599 71.2833   C85        C\n3 female   26     0     0 STON/O2. 3101282  7.9250              S\n4 female   35     1     0           113803 53.1000  C123        S\n5   male   35     0     0           373450  8.0500              S\n6   male   NA     0     0           330877  8.4583              Q\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Exploramos variables del dataset de entrenamiento\"}\ntitanic_conteo <- use_data_titanic(count = TRUE) # más adelante no contaremos por variables, porque nos interesarán los datos \"crudos\"\nnames(titanic_conteo) <- c(\"clase\", \"sexo\", \"edad\", \"supervivencia\", \"n\")\ntitanic_conteo |> explore(clase, n = n)\n```\n\n::: {.cell-output-display}\n![](hist3_titanic_files/figure-html/unnamed-chunk-3-1.png){width=672}\n:::\n\n```{.r .cell-code  code-summary=\"Exploramos variables del dataset de entrenamiento\"}\ntitanic_conteo |> describe(clase, n = n)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nvariable = clase\ntype     = character\nna       = 0 of 2 201 (0%)\nunique   = 4\n 1st     = 325 (14.8%)\n 2nd     = 285 (12.9%)\n 3rd     = 706 (32.1%)\n Crew    = 885 (40.2%)\n```\n\n\n:::\n\n```{.r .cell-code  code-summary=\"Exploramos variables del dataset de entrenamiento\"}\n# ¿Cuántos sobrevivieron de cada clase?:\ntitanic_conteo |> explore(clase,\n                          target = supervivencia,\n                          n = n, split = TRUE)\n```\n\n::: {.cell-output-display}\n![](hist3_titanic_files/figure-html/unnamed-chunk-3-2.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"También podemos explorar todas las variables del dataset de una forma más resumida\"}\ntitanic_conteo |> explore_all(n = n)\n```\n\n::: {.cell-output-display}\n![](hist3_titanic_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"skimr es un paquete que conviene memorizar\"}\nskim(titanic_conteo)\n```\n\n::: {.cell-output-display}\n\nTable: Data summary\n\n|                         |               |\n|:------------------------|:--------------|\n|Name                     |titanic_conteo |\n|Number of rows           |32             |\n|Number of columns        |5              |\n|_______________________  |               |\n|Column type frequency:   |               |\n|character                |4              |\n|numeric                  |1              |\n|________________________ |               |\n|Group variables          |None           |\n\n\n**Variable type: character**\n\n|skim_variable | n_missing| complete_rate| min| max| empty| n_unique| whitespace|\n|:-------------|---------:|-------------:|---:|---:|-----:|--------:|----------:|\n|clase         |         0|             1|   3|   4|     0|        4|          0|\n|sexo          |         0|             1|   4|   6|     0|        2|          0|\n|edad          |         0|             1|   5|   5|     0|        2|          0|\n|supervivencia |         0|             1|   2|   3|     0|        2|          0|\n\n\n**Variable type: numeric**\n\n|skim_variable | n_missing| complete_rate|  mean|  sd| p0|  p25|  p50| p75| p100|hist  |\n|:-------------|---------:|-------------:|-----:|---:|--:|----:|----:|---:|----:|:-----|\n|n             |         0|             1| 68.78| 136|  0| 0.75| 13.5|  77|  670|▇▁▁▁▁ |\n\n\n:::\n:::\n\n\n\n# Elegir una visualización adecuada\n\n::: {.callout-tip}\n## Selección de gráficos y visualizaciones que mejor representen tus datos.\n:::\n\n## ¿Hombre o mujer?\n\nHemos visto como se relaciona la supervivencia con la pertenencia a la tripulación o a una clase en concreto, pero ¿influyó el sexo?\n\nSi usamos un diagrama de mosaico, que es un método gráfico para visualizar datos de dos o más variables cualitativas, podemos tener una visión general de los datos y reconocer relaciones entre diferentes variables cualitativas.\n\nVeamos la `supervivencia` de los pasajeros del Titanic en función del `sexo` (ambas variables cualitativas).\n\n::: {.callout-important title=\"Tu turno\"}\nCompleta las partes del código señaladas por `_____` o `xxxxx` para obtener el resultado propuesto.\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntitanic <- use_data_titanic(count = _____) # ahora trabajamos con los datos \"crudos\"\nnames(titanic) <- c(\"clase\", \"sexo\", \"edad\", \"supervivencia\")\n\nmosaico2 <- ggplot(data = titanic) +\n  geom_xxxxxx(aes(x = product(supervivencia, sexo),\n                  fill = ______))\nmosaico2\n```\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](hist3_titanic_files/figure-html/mosaico-superviencia-sexo-1.png){width=672}\n:::\n:::\n\n\n\n## ¿A qué clase perteneces?¿Eres miembro de la tripulación? ¿Hombre o mujer?\n\nAvanzamos un poco más con los gráficos de mosaico, representando tres variables cualitativas.\n\nVeamos la `supervivencia` de los pasajeros del Titanic en función del `sexo` y la `clase` (todas las variables cualitativas)\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"mosaico de 3 variables\"}\nmosaico3 <- ggplot(data = titanic) +\n  geom_mosaic(aes(x = product(supervivencia, sexo, clase), fill = supervivencia))\nmosaico3\n```\n\n::: {.cell-output-display}\n![](hist3_titanic_files/figure-html/mosaico_superviencia_sexo_clase-1.png){width=672}\n:::\n:::\n\n\n\n# Eliminar el desorden. Enfocar la atención\n\nEl gráfico anterior es muy complicado de interpretar, a no ser que se exija una fuerte atención del lector. **¿Podemos facilitarle la vida?**, porque... ¡de eso se trata en visualización!\n\n## El diagrama de flujo\n\nUn diagrama de flujo es un gráfico que muestra los pasos de un proceso de una manera visual y fácil de entender, por tanto, este tipo de gráficos permitirán visualizar el flujo de los datos a través de las variables que analizamos. Véase como mejora la interpretabilidad de los datos cualitativos respecto al mosaico con tres variables variables cualitativas.\n\nAnalizamos las mismas variables cualitativas: `supervivencia`, `sexo` y `clase`, pero ahora **el gráfico es mucho más fácil de leer y, por tanto, estamos facilitando el mensaje**. En esto consiste eliminar el desorden.\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"construimos el diagrama de flujo\"}\ntabla_titanic <- titanic |>\n  group_by(clase, sexo, supervivencia) |>\n  count()\n\nflujo <- ggplot(tabla_titanic,\n       aes(axis1 = clase,\n           axis2 = sexo,\n           axis3 = supervivencia,\n           y = n)) +\n  geom_alluvium(aes(fill = clase)) +\n  geom_stratum() +\n  geom_text(stat = \"stratum\",\n            aes(label = after_stat(stratum))) +\n  scale_x_discrete(limits = c(\"clase\", \"sexo\",\n                              \"supervivencia\"),\n                   expand = c(.1, .1)) +\n  scale_fill_viridis_d() +\n  labs(title = \"Las mujeres de primera clase tuvieron preferencia\", y = \"Frecuencia\") +\n  theme_minimal() +\n  theme(legend.position = \"none\",\n        axis.title.y = element_text(hjust = 1)) \nflujo\n```\n\n::: {.cell-output-display}\n![](hist3_titanic_files/figure-html/flujo_superviencia_sexo_clase-1.png){width=672}\n:::\n:::\n\n\n\n## Los diagramas de árboles\n\nLos diagramas de árbol permiten enfocar la atención y llegar a conclusiones interesantes de una forma rápida, ya que señalan las categorías más destacables en las variables. Además, combinan la visualización con la presentación de datos muy informativos...\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"diagrama de árbol\"}\ntitanic_conteo |> explain_tree(target = supervivencia, n = n, out = \"model\")\n```\n\n::: {.cell-output-display}\n![](hist3_titanic_files/figure-html/unnamed-chunk-7-1.png){width=672}\n:::\n\n::: {.cell-output .cell-output-stdout}\n\n```\nn= 2201 \n\nnode), split, n, loss, yval, (yprob)\n      * denotes terminal node\n\n 1) root 2201 711 No (0.6769650 0.3230350)  \n   2) sexo=Male 1731 367 No (0.7879838 0.2120162)  \n     4) edad=Adult 1667 338 No (0.7972406 0.2027594) *\n     5) edad=Child 64  29 No (0.5468750 0.4531250)  \n      10) clase=3rd 48  13 No (0.7291667 0.2708333) *\n      11) clase=1st,2nd 16   0 Yes (0.0000000 1.0000000) *\n   3) sexo=Female 470 126 Yes (0.2680851 0.7319149)  \n     6) clase=3rd 196  90 No (0.5408163 0.4591837) *\n     7) clase=1st,2nd,Crew 274  20 Yes (0.0729927 0.9270073) *\n```\n\n\n:::\n:::\n\n\n\nVemos que el `sexo` y la `clase` pueden dar una buena pista de quién tiene más probabilidad de salvarse:\n\nsexo = Male: 21% supervivencia (79% de las observaciones)\nsexo = Female & clase = 3rd: 46% supervivencia (9%)\nsexo = Female & clase <> 3rd: 93% supervivencia (12%)\n\n# Una modelización muy sencilla\n\nComo somos muy buenos colegas, y ponemos mucho interés en lo que hacemos, vamos a hacer un modelo logit sencillo, para ver si ratifica nuestros hallazgos con la fase de visualización previa.\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"carga de datos de entrenamiento. Faltantes\"}\n## Cargamos los conjuntos de datos\nhead(titanic_train)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n  PassengerId Survived Pclass\n1           1        0      3\n2           2        1      1\n3           3        1      3\n4           4        1      1\n5           5        0      3\n6           6        0      3\n                                                 Name    Sex Age SibSp Parch\n1                             Braund, Mr. Owen Harris   male  22     1     0\n2 Cumings, Mrs. John Bradley (Florence Briggs Thayer) female  38     1     0\n3                              Heikkinen, Miss. Laina female  26     0     0\n4        Futrelle, Mrs. Jacques Heath (Lily May Peel) female  35     1     0\n5                            Allen, Mr. William Henry   male  35     0     0\n6                                    Moran, Mr. James   male  NA     0     0\n            Ticket    Fare Cabin Embarked\n1        A/5 21171  7.2500              S\n2         PC 17599 71.2833   C85        C\n3 STON/O2. 3101282  7.9250              S\n4           113803 53.1000  C123        S\n5           373450  8.0500              S\n6           330877  8.4583              Q\n```\n\n\n:::\n\n```{.r .cell-code  code-summary=\"carga de datos de entrenamiento. Faltantes\"}\nsum(is.na(titanic_train))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n[1] 177\n```\n\n\n:::\n\n```{.r .cell-code  code-summary=\"carga de datos de entrenamiento. Faltantes\"}\nvis_miss(titanic_train)\n```\n\n::: {.cell-output-display}\n![](hist3_titanic_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\n::: {.callout-important title=\"Tu turno\"}\nCompleta las partes del código señaladas por `xxx` para obtener el resultado propuesto. ¿Eres capaz de recordar la función para visualizar los datos faltantes?\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nvis_xxxx(titanic_train)\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"limpieza del conjunto de datos de entrenamiento\"}\n# Valores faltantes todos en la edad:\ncolSums(apply(titanic_train, 2, is.na))\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nPassengerId    Survived      Pclass        Name         Sex         Age \n          0           0           0           0           0         177 \n      SibSp       Parch      Ticket        Fare       Cabin    Embarked \n          0           0           0           0           0           0 \n```\n\n\n:::\n\n```{.r .cell-code  code-summary=\"limpieza del conjunto de datos de entrenamiento\"}\n# La edad es muy importante en el modelo, por lo que solo nos quedamos con los registros completos:\ntitanic_data <- titanic_train[complete.cases(titanic_train),]\n\n## Convertimos \"Survived\", \"Pclass\", \"Sex\" y \"Embarked\" a factores\nfor (i in c(\"Survived\", \"Pclass\", \"Sex\", \"Embarked\")){\n  titanic_data[,i] = as.factor(titanic_data[,i])\n}\n\n# Nos quedamos con las variables útiles\ntitanic_data <- titanic_data |>\n  select(-c(PassengerId, Name, Ticket, Cabin))\n```\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"modelo\"}\n## Separando entrenamiento y test\ntrain <- titanic_data[1:535,] # 75%\ntest <- titanic_data[536:714,]\n\n## Creación del modelo\nmodelo <- glm(Survived ~ .,\n             family = binomial(link ='logit'),\n             data = train)\n\n## Resumen del modelo\nsummary(modelo)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n\nCall:\nglm(formula = Survived ~ ., family = binomial(link = \"logit\"), \n    data = train)\n\nCoefficients:\n              Estimate Std. Error z value Pr(>|z|)    \n(Intercept)  15.094590 535.411379   0.028 0.977509    \nPclass2      -1.052932   0.389053  -2.706 0.006802 ** \nPclass3      -2.325970   0.409228  -5.684 1.32e-08 ***\nSexmale      -2.556828   0.249817 -10.235  < 2e-16 ***\nAge          -0.035646   0.009318  -3.825 0.000131 ***\nSibSp        -0.289893   0.140889  -2.058 0.039629 *  \nParch        -0.067103   0.147473  -0.455 0.649097    \nFare         -0.002175   0.003412  -0.637 0.523819    \nEmbarkedC   -10.911734 535.411287  -0.020 0.983740    \nEmbarkedQ   -11.374456 535.411563  -0.021 0.983051    \nEmbarkedS   -11.321779 535.411276  -0.021 0.983129    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n\n(Dispersion parameter for binomial family taken to be 1)\n\n    Null deviance: 723.98  on 534  degrees of freedom\nResidual deviance: 495.19  on 524  degrees of freedom\nAIC: 517.19\n\nNumber of Fisher Scoring iterations: 12\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"anova del modelo\"}\nanova(modelo, test = \"Chisq\")\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nAnalysis of Deviance Table\n\nModel: binomial, link: logit\n\nResponse: Survived\n\nTerms added sequentially (first to last)\n\n         Df Deviance Resid. Df Resid. Dev  Pr(>Chi)    \nNULL                       534     723.98              \nPclass    2   61.153       532     662.83 5.259e-14 ***\nSex       1  146.844       531     515.99 < 2.2e-16 ***\nAge       1   11.368       530     504.62 0.0007472 ***\nSibSp     1    6.848       529     497.77 0.0088760 ** \nParch     1    0.435       528     497.34 0.5095355    \nFare      1    0.227       527     497.11 0.6335531    \nEmbarked  3    1.915       524     495.19 0.5902119    \n---\nSignif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1\n```\n\n\n:::\n:::\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"predicciones, matriz de confusión y curva ROC\"}\n## Prediciendo el conjunto de test\nresultado <- predict(modelo, newdata = test[,-1],\n                     type = 'response')\nresultado_factor <- as.factor(ifelse(resultado > 0.5,1,0))\n\n## Confusion matrix and statistics\nconfusionMatrix(data = resultado_factor,\n                reference = test$Survived)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\nConfusion Matrix and Statistics\n\n          Reference\nPrediction  0  1\n         0 95 19\n         1 13 52\n                                          \n               Accuracy : 0.8212          \n                 95% CI : (0.7571, 0.8744)\n    No Information Rate : 0.6034          \n    P-Value [Acc > NIR] : 2.835e-10       \n                                          \n                  Kappa : 0.621           \n                                          \n Mcnemar's Test P-Value : 0.3768          \n                                          \n            Sensitivity : 0.8796          \n            Specificity : 0.7324          \n         Pos Pred Value : 0.8333          \n         Neg Pred Value : 0.8000          \n             Prevalence : 0.6034          \n         Detection Rate : 0.5307          \n   Detection Prevalence : 0.6369          \n      Balanced Accuracy : 0.8060          \n                                          \n       'Positive' Class : 0               \n                                          \n```\n\n\n:::\n\n```{.r .cell-code  code-summary=\"predicciones, matriz de confusión y curva ROC\"}\n## Curva ROC\nauc = roc(test$Survived, resultado) # puntuación AUC\nplot(auc, main =\"Curva ROC. Regresión logística\")\n```\n\n::: {.cell-output-display}\n![](hist3_titanic_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n\n# Contar una historia\n\n::: {.callout-tip}\n## Cómo narrar una historia convincente con tus datos.\n\nHasta ahora hemos visto el **planteamiento**, en el que proporcionamos el contexto: un colega de departamento nos ha pedido ayuda. Si es científico, como nosotros, podemos utilizar todo nuestro arsenal gráfico sin problemas. Como quiere hacer predicción, está interesado en ver la influencia de las variables en la `supervivencia`.\n\nEl análisis exploratorio nos introduce de lleno en la **trama**, donde descubrimos que la `edad`, el `sexo` y la `clase` tienen influencia en la variable `supervivencia`.\n\nPero como siempre, lo más importante es el **desenlace**, donde le estamos dando a nuestro colega las claves que necesita:\n\n-   Con el gráfico de flujo va a ver claramente como el sexo, la edad y la clase los tiene que tener en cuenta en el modelo: **la tercera clase tuvo un ratio de supervivencia claramente menor al contrario que las mujeres y los niños**.\n\n-   Un simple modelo `logit` nos hace encontrar otra variable: un **número de hermanos y esposas** mayor, aumenta la `supervivencia`.\n:::\n\n## Para pensar:\n\nSi se hundiera hoy en día el Titanic, ¿habría cambiado la influencia de alguna variable en el modelo? ¿Tendríamos una visualización más confusa en el gráfico de flujo?\n",
    "supporting": [
      "hist3_titanic_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}