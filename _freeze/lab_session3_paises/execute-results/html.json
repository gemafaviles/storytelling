{
  "hash": "1f94eb8552223722437789167f0559c1",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Storytelling visual con R. Lab 3: demografía (cuantitativos)\"\nsubtitle: \"Curso formativo para el PDI. Universidad de Castilla-La Mancha\"\nauthor:   \n  - name: Gema Fernández-Avilés \n    email: gema.faviles@uclm.es\n  - name: Isidro Hidalgo\n    email: isidro.hidalgo@uclm.es \ndate: \"2025-03-09\"\nformat:\n  html:\n    theme: cerulean\n    highlight-style: ayu-mirage\n    self-contained: true\n    lang: es\n    date-format: long\n    embed-resources: true\n    toc-title: Summary\n    toc: true\n    number-sections: true\n    preview-links: auto\n    code-link: true\nnumber-sections: true\nexecute:\n  echo: true\n  eval: true\n  output: true\n  include: true\n  freeze: auto\n  fig-height: 5\n  warning: false\n  comment: \"#>\"\n  code-line-numbers: true\n  code-copy: true\n  code-overflow: scroll\n---\n\n\n\n\n\n\n::: {.callout-warning}\n## IMPORTANTE\n\n📕 **Como buen estudiante que eres, sabrás lo importante que es trabajar de forma autónoma y venir a clase con el material leído 😊**. \n\n🦄 <mark> Este icono indica **AVANZADO E IMPORTANTE**</mark>\n\n:::\n\n\n# Los datos\n\nLos datos que se utilizan en esta historia están disponibles en el repositorio GitHub \"From data to viz\": https://github.com/holtzy/data_to_viz. Además, se ha facilitado un archivo Excel\n\n\n\n# ¡Nos vamos a Noruega! 🥶\n\n¡Ah, la vida del analista de datos! Mi jefe me ha pedido que realice un análisis exploratorio (aunque en realidad siempre quiere gráficos impresionantes con conclusiones fascinantes) de unos datos demográficos por países. Pero aquí viene lo mejor: quiere que lo acompañe a Noruega para un *workshop* \"fantástico\" [sic]...\n\nCon el frío que hace ahora en Noruega, uno se pregunta: ¿por qué no elige destinos con más criterio? ¡Hawái, por ejemplo, sería una opción mucho más cálida y agradable!\n\n\n\n::: {.callout-tip}\n\n## Entender el contexto: cómo definir el propósito y la audiencia de tu análisis\n\nEn este caso, lo que me pide el jefe es un análisis exploratorio. Básicamente, se trata de encontrar relaciones interesantes entre variables, observar su evolución para ver si surge algo llamativo, y preparar gráficos que vayan al grano, como ya sabemos hacer... \n\n🎓 ¡Para eso sirven los cursos de la UCLM\n:::\n\n\n**Paso (i):** Lectura de paquetes\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(tidyverse)\nlibrary(psych)\nlibrary(GGally)\nlibrary(corrplot)\nlibrary(plotly)\n```\n:::\n\n\n\n\n**Paso (ii):** Lectura de los datos \n\n+ Opción (a): Lectura de datos formato `csv` directamente desde la web\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndemog_data <- read.table(\"https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/multivariate.csv\", header = T, sep = \";\")\n```\n:::\n\n\n\n+ Opción (b): Lectura de datos formato `csv` (recuerda que mis datos están guardados en la carpeta `data`, ¿los tuyos también o no?)\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndemog_data <- read.table(\"data/multivariate.csv\", header = T, sep = \";\")\n```\n:::\n\n\n\n\n::: {.callout-warning title=\"Tu turno\"}\n## Tu turno\n\nCompleta las partes del código señaladas por `_____` o `xxxxx` para obtener el resultado propuesto y acuérdate de cambiar `eval: false` por `eval: true` cuando lo hayas cumplimentado para que se ejecute correctamente la chunk.\n:::\n\n\n\n# ¿Cómo son mis datos?\n\n**Paso 1** Muestra las primeras filas del conjunto de datos `demog_data`.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(_______)\n```\n:::\n\n\n\n\n**Paso 2** Echa un vistazo a la estructura de las variables con la función `glimpse()`.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n________(demog_data)\n```\n:::\n\n\n\n\n**Paso 3** Haz unos descriptivos básicos con la función `describe()` del paquete `psych`.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n________(demog_data)\n```\n:::\n\n\n\n\n**Paso 4** Aquí va otra opción interesante con la función `skim()` del paquete `skim`.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nskimr::skim(demog_data)\n```\n\n::: {.cell-output-display}\n\nTable: Data summary\n\n|                         |           |\n|:------------------------|:----------|\n|Name                     |demog_data |\n|Number of rows           |201        |\n|Number of columns        |11         |\n|_______________________  |           |\n|Column type frequency:   |           |\n|character                |3          |\n|numeric                  |8          |\n|________________________ |           |\n|Group variables          |None       |\n\n\n**Variable type: character**\n\n|skim_variable | n_missing| complete_rate| min| max| empty| n_unique| whitespace|\n|:-------------|---------:|-------------:|---:|---:|-----:|--------:|----------:|\n|Country       |         0|             1|   4|  32|     0|      201|          0|\n|Group         |         0|             1|   4|  13|     0|       14|          0|\n|Continent     |         0|             1|   4|  13|     0|        6|          0|\n\n\n**Variable type: numeric**\n\n|skim_variable    | n_missing| complete_rate|     mean|        sd|    p0|     p25|     p50|      p75|       p100|hist  |\n|:----------------|---------:|-------------:|--------:|---------:|-----:|-------:|-------:|--------:|----------:|:-----|\n|Pop              |         0|             1| 36411.24| 142051.30| 95.00| 1198.00| 6213.00| 22445.00| 1393686.00|▇▁▁▁▁ |\n|Birth_rate       |         0|             1|    20.13|      9.78|  7.50|   11.90|   17.70|    27.50|      48.40|▇▅▂▂▁ |\n|Mortality_rate   |         0|             1|     7.87|      2.83|  1.60|    6.00|    7.50|     9.40|      16.19|▁▇▆▂▁ |\n|Life_expectancy  |         0|             1|    72.39|      8.17| 48.90|   66.80|   74.40|    78.30|      84.60|▁▂▅▇▆ |\n|Infant_mortality |         0|             1|    22.53|     21.31|  1.30|    5.50|   14.50|    36.20|      86.80|▇▂▂▁▁ |\n|Child_per_woman  |         0|             1|     2.67|      1.27|  1.03|    1.75|    2.17|     3.56|       7.43|▇▃▂▁▁ |\n|Growth_rate      |         0|             1|    12.03|     10.13| -7.60|    3.70|   11.10|    20.30|      40.10|▃▇▆▃▁ |\n|Pop_aged_65      |         0|             1|  2370.18|   7563.33|  5.00|   93.00|  464.00|  1493.00|   83498.00|▇▁▁▁▁ |\n\n\n:::\n:::\n\n\n\n\n\n# Elegir una visualización adecuada\n\n::: {.callout-tip}\n## Selección de gráficos y visualizaciones que mejor representen tus datos. En este caso la mayoría son variables cuantitativas.\n:::\n\n📊  **Matriz diagramas de dispersión** (*scatterplot matrix*)\n\nPodemos comenzar por una matriz de puntos de las variables cuantitativas. El paquete `GGally` ofrece una visualización muy elaborada para un primer vistazo con la función `ggpairs()`.\n\n::: {.callout-tip}\n## Cuidado: solo variables cuantitativas.\n:::\n\n\n**Paso 1**  Selecciona las variables cuantitativas del conjunto de datos `demog_data` y guardarlas en el objeto `demo_cuanti`. \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndemo_cuanti <- demog_data |>\n   select(Pop, Birth_rate, Mortality_rate, Life_expectancy,\n          Infant_mortality, Child_per_woman,  Growth_rate,\n          Pop_aged_65) |>\n   na.omit()\n```\n:::\n\n\n\n\n**Paso 2** **Matriz de correlaciones y diagramas de dispersión** con la función `ggpairs()` de la librería `GGally`\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndemo_cuanti |> \n   ggpairs(progress = FALSE)\n```\n\n::: {.cell-output-display}\n![](lab_session3_paises_files/figure-html/unnamed-chunk-9-1.png){width=672}\n:::\n:::\n\n\n\n📊  **Matriz de correlaciones** \n\nHay muchas asociaciones interesantes entre diferentes variables. Aquí ya vemos mucha tela que cortar. Por no extendernos, analizaremos una de las relaciones más adelante. Pero primero, es muy interesante ver la matriz de correlaciones que, aunque con `ggpairs()` teníamos ya una primera impresión, el paquete `corrplot` nos ofrece una visualización ideal con la función `corrplot.mixed()`\n\n\n**Paso 3** Primero calculo la matriz de correlaciones con la función `cor()` y luego la represento con la función `corrplot.mixed()` que presenta múltiples posibilidades.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndemo_cuanti |> \n  cor() |> \n  corrplot.mixed( order = 'AOE')\n```\n\n::: {.cell-output-display}\n![](lab_session3_paises_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\n\n📊  **Gráfico de puntos o scatterplot** \n\n\nComo ejemplo, vamos a ver la relación entre la tasa de crecimiento, `Growth_rate`, y la esperanza de vida, `Life_expectancy`, que ya hemos visto que existe relación estadística. Empecemos con diagrama de puntos.\n\n\n**Paso 4** ¿Te acuerdas de la función de `ggplot2` para una capa de puntos?\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(demog_data,\n         aes(x = Growth_rate, y = Life_expectancy)) +\n  geom_xxxxxxxx() +\n  labs(title = \"Esperanza de vida vs. Tasa de crecimiento\",\n       x = \"Tasa de crecimiento\",\n       y = \"Esperanza de vida\") +\n  theme_minimal()\n```\n:::\n\n\n\n\n\n📊  **Hexbin plot** \n\n**Paso 5** ¿Te acuerdas de la función de `ggplot2` para convertir puntos en densidades de forma hexagonal?\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(demog_data,\n       aes(x = Growth_rate, y = Life_expectancy)) +\n  geom_xxx() +\n  labs(title = \"Esperanza de vida vs. Tasa de crecimiento\",\n       x = \"Tasa de crecimiento\",\n       y = \"Esperanza de vida\") +\n  theme_minimal()\n```\n:::\n\n\n\n\n🔍 **Eliminar el desorden. Enfocar la atención**\n\n¿Qué herramientas tenemos a nuestro alcance para poner el foco sobre lo que nos interesa? Aquí podemos usar la estética y las facetas, para separar los puntos y dar más información a través de la visualización. Veamos...\n\n\n**Paso 5** Diagrama de dispersión mejorado por estética incluyendo la variable `Pop` para el tamaño de los puntos.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n  ggplot(demog_data,\n         aes(x = Growth_rate, y = Life_expectancy, \n             _____ = Pop)) +\n  scale_size(range = c(.1, 20)) +\n  labs(title = \"Esperanza de vida vs. Tasa de crecimiento\",\n       x = \"Tasa de crecimiento\",\n       y = \"Esperanza de vida\") +\n  theme_minimal() \n```\n:::\n\n\n\n\n**Paso 6** Añade la variable `Continent` en el análisis para representar por colores los continentes en la estética de la función `aes()`. Además, añade cierta transparencia porque puede que los puntos más grandes estén tapando a los más pequeños. Escribe el título que consideres más apropiado. Ahora, el gráfico lo vamos a guardar en un objeto llamado `g_demog`.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ng_demog <- ggplot(demog_data,\n         aes(x = Growth_rate, y = Life_expectancy, \n             _____ = Pop,\n             _____ = Continent)) +\n  geom_point(_____ = 0.5) +\n  scale_size(range = c(.1, 20)) +\n  labs(title = \"_______________________________\",\n       x = \"Tasa de crecimiento\",\n       y = \"Esperanza de vida\") +\n  theme_minimal() \n\n# para represenar el gráfico\n\ng_demog\n```\n:::\n\n\n\n\n📊  **Gráficos interactivos** \n\n**Paso 7** Hacemos interactivo el gráfico anterior con la función `ggplotly()` de la libreriá `pltoly`.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplotly(_____)\n```\n:::\n\n\n\n\nEstamos usando **dos variables para enfocar la atención aportando información: el tamaño del país y el continente**. Solo con eso vemos enseguida por donde van los tiros: la mayor parte de los países de Europa tienen gran esperanza de vida y crecimiento moderado. Por el contrario, Sudamérica tiene tasas de crecimiento muy elevadas (son países en fases de expansión económica) y una menor esperanza de vida, a falta de consolidar sanidad y otros servicios en general.\n\nTambién somos capaces de identificar China e India rápidamente, por su tamaño, y Japón arriba a la izquierda por su tamaño medio-grande y enorme esperanza de vida.\n\nSin embargo, hay colores muy parecidos, que exigen demasiada atención. Podemos usar la siguiente herramienta...\n\n \n\n📊  **Facetas** \n\nOtra forma de eliminar el desorden y enfocar la atención es usar facetas, separando el gráfico según una o más variables interesantes. En este caso usamos solo el continente.\n\n\n🦄 **Paso 8** Diagrama de dispersión mejorado por facetas con la función `facet_wrap()`.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndemog_scatter <- ggplot(data = demog_data, # data\n              aes(x = Growth_rate, y = Life_expectancy, colour = Continent)) + #aesthetics\n    geom_point(alpha = 0.5) + #geometries\n    facet_wrap(~ Continent, scales = \"free\") + #facets\n    labs(title = \"Life expectancy at birth vs. Per capita GDP\", \n         x = \"Growth_rate\", y = \"Life_expectancy\", colour = \"Continent\") + #labels\n    theme_light() #themes\n\ndemog_scatter \n```\n\n::: {.cell-output-display}\n![](lab_session3_paises_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n\n❓ **¿Qué problema podría tener este gráfico?**\n\n::: {.callout-tip}\n## Pista\n\n¡Fijaos en los ejes!\n:::\n\nExacto: las escalas. Pero hemos dicho \"podría\", no que tenga un problema en sí. Cuando nuestra intención es mirar dentro de cada faceta para ver la relación entre las variables, es posible que nos interese dejarlo como está.\n\nPero muchas veces es muy importante, cuando usamos facetas, que podamos comparar los diferentes grupos entre sí. En este caso, es imprescindible usar la misma escala en todas las facetas. Para ello, hay que especificar los límites de las escalas de los ejes.\n\n¿Existe una forma fácil de saber cuáles poner? Claro, con un `summary()` de las variables, tal como indicamos a continuación, vemos rápidamente el valor mínimo y máximo de las variables que nos interesan:\n\n\n🦄 **Paso 9 ** Mejoramos la escala para comparar facetas: observamos los límites de las variables.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsummary(demog_data$Life_expectancy)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n  48.90   66.80   74.40   72.39   78.30   84.60 \n```\n\n\n:::\n\n```{.r .cell-code}\nsummary(demog_data$Growth_rate)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n   Min. 1st Qu.  Median    Mean 3rd Qu.    Max. \n  -7.60    3.70   11.10   12.03   20.30   40.10 \n```\n\n\n:::\n:::\n\n\n\n\n🦄 **Paso 10** Especificamos los límites en los \n\n\n::: {.cell}\n\n```{.r .cell-code}\ndemog_scatter_escala <- ggplot(data = demog_data,\n                               aes(x = Growth_rate,\n                                   y = Life_expectancy,\n                                   colour = Continent)) +\n  geom_point(alpha = 0.5) +\n  facet_wrap(~ Continent, scales = \"free\") +\n  labs(title = \"Esperanza de vida respecto al PIB per capita\",\n       x = \"Tasa de crecimiento\", y = \"Esperanza de vida\",\n       colour = \"Continent\") +\n  scale_x_continuous(limits = c(-10, 45)) +\n  scale_y_continuous(limits = c(45, 85)) +\n  theme_light()\n\ndemog_scatter_escala \n```\n\n::: {.cell-output-display}\n![](lab_session3_paises_files/figure-html/unnamed-chunk-18-1.png){width=672}\n:::\n:::\n\n\n\n\n\n📈 **Linea de suavizado**\n\nA veces, si hay una tendencia evidente, es conveniente usar una línea de suavizado que la identifique. En este caso, no está nada clara, por lo que la podemos omitir. Y aquí sí es interesante dejar libre la escala, para maximizar la visualización de la tendencia, que es lo que nos interesa.\n\n**Paso 11**  Añadimos línea de suavizado con la función `geom_smooth()`.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n______ + geom_smooth(method = NULL, se = TRUE) \n```\n:::\n\n\n\n\n::: {.callout-tip}\n## Cómo narrar una historia convincente con tus datos.\n\nHemos visto el **planteamiento**, en el que proporcionamos el contexto: trabajamos para un jefe que nos ha pedido algo muy concreto: un análisis exploratorio (y sabemos que lo quiere con conclusiones)...\n\nEl análisis exploratorio podemos usarlo para ir introduciendo la **trama**, donde vemos enseguida relaciones interesantes entre algunas parejas de variables... Solo hemos analizado la esperanza de vida al nacer respecto a la tasa de crecimiento, pero en la matriz de puntos hemos visto muchas, por lo que el jefe estará feliz.\n\nLa segmentación también nos ha proporcionado agrupaciones de países, aunque visualmente son difíciles de interpretar, por lo que lo más lógico sería seleccionar un conjunto de países de interés, que consiga un análisis (y su visualización) más interesante.\n\nComo siempre, lo más importante es el **desenlace**, donde le estamos dando a nuestro jefe las claves que necesita:\n\n-   La matriz de puntos es vital, si nuestro superior está habituado al análisis, porque **se aprecia un número importante de relaciones claras entre variables**.\n\n-   En cada variable **podemos usar la estética y las facetas para potenciar la visualización**, determinando las variables que suministran información en las relaciones encontradas.\n\nFinalmente, hemos visto que, cuando tenemos un número elevado de información, tenemos que adoptar una decisión equilibrada entre la información que suministramos en nuestros gráficos y nuestra habilidad para eliminar el desorden y enfocar la mirada del espectador a lo que nos interesa más. Para el caso que nos ocupa, podemos:\n\n-   Usar la agrupación previa por zonas geográficas, como hemos hecho antes.\n\n-   Restringir la visualización a una zona geográfica concreta.\n\n-   Filtrar determinados países para quedarnos con los que nos interesa comparar.\n\n-   Directamente usar una tabla, relacionando todos los países de interés.\n:::\n\n![](img/logos_finan.png){align=\"right\"}\n",
    "supporting": [
      "lab_session3_paises_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}