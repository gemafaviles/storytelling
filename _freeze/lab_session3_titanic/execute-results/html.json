{
  "hash": "a0ac0f0f3296449e4167484a5ce378e6",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Storytelling visual con R: primera clase\"\nsubtitle: \"Curso formativo para el PDI. Universidad de Castilla-La Mancha\"\nauthor:   \n  - name: Gema Fern√°ndez-Avil√©s \n    email: gema.faviles@uclm.es\n  - name: Isidro Hidalgo\n    email: isidro.hidalgo@uclm.es \ndate: \"2025-03-04\"\nformat:\n  html:\n    theme: cerulean\n    highlight-style: ayu-mirage\n    self-contained: true\n    lang: es\n    date-format: long\n    embed-resources: true\n    toc-title: Summary\n    toc: true\n    number-sections: true\n    preview-links: auto\n    code-link: true\nnumber-sections: true\nexecute:\n  echo: true\n  eval: true\n  output: true\n  include: true\n  freeze: auto\n  fig-height: 5\n  warning: false\n  comment: \"#>\"\n  code-line-numbers: true\n  code-copy: true\n  code-overflow: scroll\n---\n\n\n\n\n::: {.callout-warning}\n## IMPORTANTE\n\n**Como buen estudiante que eres, sabr√°s lo importante que es trabajar de forma aut√≥noma y venir a clase con el material le√≠do üòä**. \n:::\n\n\n# Los datos üõ≥\n\nLos datos para esta historia est√°n sacados de la competici√≥n de kaggle [Titanic - Machine Learning from Disaster](https://www.kaggle.com/competitions/titanic). Los datasets de entrenamiento y test se encuentran en el objeto `titanic` del paquete `titanic`. Adem√°s, se ha proporcionado un archivo Excel con los datos para facilitar su manipulaci√≥n,\nel archivo `titanic.xlsx`\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nif (!require(titanic)){install.packages(\"titanic\")}\n```\n:::\n\n\n\nüôâ **Entender el contexto**\n\n¬°Ay, las apuestas entre departamentos! Mi colega del departamento se ha picado con el equipo vecino y han apostado que ganar√°n el pr√≥ximo datathon de GAIA-X. No ser√≠a mi problema, si no fuera porque me ha pedido ayuda con el an√°lisis exploratorio... ¬°y est√° fatal de tiempo! Lo de siempre... ¬°¬øPero por qu√© no pueden dejarme en paz?!\n\nEn fin, como el objetivo de mi colega es la predicci√≥n, nuestro trabajo consiste en hacer un an√°lisis exploratorio de los datos, que son casi todos cualitativos, con una variable dependiente tambi√©n cualitativa, para ver las relaciones entre las variables del conjunto de datos. Luego ya se apa√±ar√° mi compa√±ero para modelizar... ¬°a ver si se piensa que lo voy a hacer todo yo! üòÖ\n\n**Paso (i):** Lectura de paquetes.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n#library(titanic)\nlibrary(tidyverse)\nlibrary(readxl)\n#library(skimr)\n#library(explore)\nlibrary(ggmosaic)\nlibrary(ggalluvial)\nlibrary(visdat)\n```\n:::\n\n\n\n\n**Paso (ii):** Lectura de datos.\n\n+ Opci√≥n (a): Lectura del archivo `titanic.xlsx`\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntitanic <- read_xlsx(\"data/titanic.xlsx\")\n```\n:::\n\n\n\n+ Opci√≥n (b): Podr√≠amos descargar directamente del paquete `titanic` el dataset `titanic_train`\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntitanic <- titanic::titanic_train\n```\n:::\n\n\n\n\n\n::: {.callout-warning title=\"Tu turno\"}\n## Tu turno\nCompleta las partes del c√≥digo se√±aladas por `_____` o `xxxxx` para obtener el resultado propuesto y acu√©rdate de cambiar `eval: false` por `eval: true` cuando lo hayas cumplimentado para que se ejecute correctamente la chunk.\n:::\n\n\n# üë®‚Äçüë©‚Äçüëß‚Äçüëß **¬øQui√©n viajaba en el Titanic?** \n\n**Paso 1** Muestra las primeras filas del conjunto de datos `titanic`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nhead(________)\n```\n:::\n\n\n\n\n**Paso 2** Echa un vistazo a la estructura de las variables con la funci√≥n `glimpse()`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\n_____(titanic)\n```\n:::\n\n\n\n\n**Paso 3** Convierte las variables caracteres a factores con la funci√≥n `mutate_if()`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntitanic <- titanic |>\n  mutate_if(is.character, as.factor)\n```\n:::\n\n\n\n\n**Paso 4** Convierte la variable `Survived` de num√©rica a factor con la funci√≥n `as.factor()`.\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntitanic$Survived <- as.factor(titanic$Survived)\n```\n:::\n\n\n\n\n**Paso 5** Haz un resumen esploratorio r√°pido y global con la funci√≥n `skim()` del paquete `skimr`\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nskimr::skim(titanic)\n```\n\n::: {.cell-output-display}\n\nTable: Data summary\n\n|                         |        |\n|:------------------------|:-------|\n|Name                     |titanic |\n|Number of rows           |891     |\n|Number of columns        |12      |\n|_______________________  |        |\n|Column type frequency:   |        |\n|factor                   |6       |\n|numeric                  |6       |\n|________________________ |        |\n|Group variables          |None    |\n\n\n**Variable type: factor**\n\n|skim_variable | n_missing| complete_rate|ordered | n_unique|top_counts                     |\n|:-------------|---------:|-------------:|:-------|--------:|:------------------------------|\n|Survived      |         0|          1.00|FALSE   |        2|0: 549, 1: 342                 |\n|Name          |         0|          1.00|FALSE   |      891|Abb: 1, Abb: 1, Abb: 1, Abe: 1 |\n|Sex           |         0|          1.00|FALSE   |        2|mal: 577, fem: 314             |\n|Ticket        |         0|          1.00|FALSE   |      681|160: 7, 347: 7, CA.: 7, 310: 6 |\n|Cabin         |       687|          0.23|FALSE   |      147|B96: 4, C23: 4, G6: 4, C22: 3  |\n|Embarked      |         2|          1.00|FALSE   |        3|S: 644, C: 168, Q: 77          |\n\n\n**Variable type: numeric**\n\n|skim_variable | n_missing| complete_rate|   mean|     sd|   p0|    p25|    p50|   p75|   p100|hist  |\n|:-------------|---------:|-------------:|------:|------:|----:|------:|------:|-----:|------:|:-----|\n|PassengerId   |         0|           1.0| 446.00| 257.35| 1.00| 223.50| 446.00| 668.5| 891.00|‚ñá‚ñá‚ñá‚ñá‚ñá |\n|Pclass        |         0|           1.0|   2.31|   0.84| 1.00|   2.00|   3.00|   3.0|   3.00|‚ñÉ‚ñÅ‚ñÉ‚ñÅ‚ñá |\n|Age           |       177|           0.8|  29.70|  14.53| 0.42|  20.12|  28.00|  38.0|  80.00|‚ñÇ‚ñá‚ñÖ‚ñÇ‚ñÅ |\n|SibSp         |         0|           1.0|   0.52|   1.10| 0.00|   0.00|   0.00|   1.0|   8.00|‚ñá‚ñÅ‚ñÅ‚ñÅ‚ñÅ |\n|Parch         |         0|           1.0|   0.38|   0.81| 0.00|   0.00|   0.00|   0.0|   6.00|‚ñá‚ñÅ‚ñÅ‚ñÅ‚ñÅ |\n|Fare          |         0|           1.0|  32.20|  49.69| 0.00|   7.91|  14.45|  31.0| 512.33|‚ñá‚ñÅ‚ñÅ‚ñÅ‚ñÅ |\n\n\n:::\n:::\n\n\n\n# üåä **¬øQui√©n sobrevivi√≥? Centra la atenci√≥n**\n\n**Paso 1** Utiliza un gr√°fico de barras para representar la variable `Survived`  \n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(titanic, aes(x= Survived)) +\n  geom_xxxx() +\n  xlab(\"_____\") +\n  ylab(\"_____\")\n```\n:::\n\n\n\n\n**Paso 2** üí∞ Analiza la variable `Survived` teniendo en cuenta la clase del pasajero `Pclass` con un diagrama de barras. ¬øTe acuerdas de como se especificaba este tipo de geometr√≠a?\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(titanic,\n  aes(Pclass)) +\n  geom_xxx(aes(fill = Survived))\n```\n:::\n\n\n\n**Paso 3** üí∞ Analiza la variable `Survived` teniendo en cuenta la clase del pasajero `Pclass` y mejora la est√©tica del gr√°fico. Para ello, puedes ayudarte de la funci√≥n `scale_fill_manual()`\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(________, aes(__________)) +\n  geom_xxx(aes(fill = ________) )  +\n    scale_fill_manual(name=\" \", \n                      values = c(\"0\" = \"grey\", \"1\" = \"green\"), \n                      labels=c(\"Died\", \"Survived\")) +\n    labs(x = \"Ticket class\", \n         title=\"Survival rate by ticket classes\") +\ntheme_xxxxx()\n```\n:::\n\n\n\n**Paso 4** üë∂ Analiza la variable `Survived` teniendo en cuenta la edad del pasajero `Age` mediante un diagrama de caja o boxplot con la funci√≥n `geom_boxplot()`. Considera la variable `x = Survived` e `y = Age`.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(_______, \n       aes(x = ________, y = _______)) +\n  geom_xxxxxx() +\n  xlab(\"Survived\") +\n  ylab(\"Age\")\n```\n:::\n\n\n\n**Paso 5** üë∂ Analiza la variable `Survived` teniendo en cuenta la edad del pasajero `Age` mediante un gr√°fico de viol√≠n con la funci√≥n `geom_violin()` y a. Considera la variable `x = Survived` e `y = Age`.\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(titanic, \n       aes(x = Survived, y = Age)) +\n  geom_violin(col = \"red\") +\n  geom_jitter(width = 0.1, alpha = 0.3, col=\"red\") +\n  xlab(\"Survived\") +\n  ylab(\"Age\") +\n  theme_bw()\n```\n:::\n\n\n\n\n\n\n\n# ü§µ üë∞ **¬øHombre o mujer? Elegir una visualizaci√≥n adecuada**\n\nUna pregunta que podemos hacernos enseguida es: ¬øinfluy√≥ el sexo en la supervivencia?\n\nSi usamos un **diagrama de mosaico**, que es un m√©todo gr√°fico para visualizar datos de dos o m√°s variables cualitativas, podemos tener una visi√≥n general de los datos y reconocer relaciones entre diferentes variables cualitativas.\n\nVeamos la supervivencia (`Survived`) de los pasajeros del Titanic en funci√≥n del sexo (`Sex`) (ambas variables cualitativas).\n\n\n\n** Paso 1** Primer mosaico con las variables `Survived` y `sexo`\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = titanic) +        \n  geom_mosaic(aes(x = product(Survived, Sex),  # Combina supervivencia y sexo en el eje x\n                  fill = Survived))            # Colorea los mosaicos seg√∫n la variable supervivencia\n```\n\n::: {.cell-output-display}\n![](lab_session3_titanic_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n\n\n**Paso 2** Avanzamos un poco m√°s con los gr√°ficos de mosaico, representando tres variables cualitativas. Veamos la supervivencia (`Suvived`) de los pasajeros del Titanic en funci√≥n del sexo (`Sex`) y la clase (`Pclass`) (todas las variables cualitativas)\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = titanic) +\n  geom_mosaic(aes(x = product(Survived, Sex, Pclass), \n                  fill = Survived))\n```\n\n::: {.cell-output-display}\n![](lab_session3_titanic_files/figure-html/mosaico_superviencia_sexo_clase-1.png){width=672}\n:::\n:::\n\n\n\n\n**Paso 2** El gr√°fico anterior es muy complicado de interpretar y exige un enorme esfuerzo del lector, por su elevada carga cognitiva. **¬øPodemos facilitarle la vida?**, porque... ¬°de eso se trata en visualizaci√≥n!No nos gusta el mosaico, dif√≠cil de interpretar. Probemos con `face_wrap()` y especifiquemos algunos detalles para una visualizaci√≥n adecuada.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nggplot(data = titanic, aes(x = Age, fill = Sex, alpha = Survived)) +\n  geom_bar(stat = \"bin\", bins = 30, data = filter(titanic, Sex == \"male\"), color = \"grey\") +\n  geom_bar(stat = \"bin\", bins = 30, data = filter(titanic, Sex == \"female\"), aes(y = ..count.. * (-1)), color = \"grey\") +\n  scale_fill_viridis_d() +\n  coord_flip() +                      # barras horizontales \n  theme_bw() +                        # tema del gr√°fico\n  facet_wrap(. ~ Pclass) +            # clase en columnas\n  labs(title = \"Survival distributions by age, gender and ticket class\")\n```\n\n::: {.cell-output-display}\n![](lab_session3_titanic_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n\n\nUn diagrama de flujo es un gr√°fico que muestra los pasos de un proceso de una manera visual y f√°cil de entender, por tanto, este tipo de gr√°ficos permitir√°n visualizar el flujo de los datos a trav√©s de las variables que analizamos. V√©ase como mejora la interpretabilidad de los datos cualitativos respecto al mosaico con tres variables cualitativas.\n\nAnalizamos las mismas variables cualitativas, supervivencia (`Suvived`), sexo (`Sex`) y clase (`Pclass`) pero ahora **el gr√°fico es mucho m√°s f√°cil de leer y, por tanto, estamos facilitando el mensaje**. En esto consiste eliminar el desorden.\n\n**Paso 3** Creamos un objeto `tabla_titanic` con las variables objeto de inter√©s\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntabla_titanic <- titanic |>   \n  group_by(Pclass, Sex, Survived) |>       # Agrupa los datos por clase, sexo y supervivencia\n  count()                                  # Cuenta el n√∫mero de ocurrencias en cada grupo\n```\n:::\n\n\n\n\n**Paso 3** Representamos el diagrama de flujo. Funciones importantes: `geom_alluvium()`, que a√±ade los flujos y `geom_stratum()` que a√±ade los estratos o categor√≠as.\n\n\n::: {.cell}\n\n```{.r .cell-code}\nflujo <- ggplot(tabla_titanic,              # Crea un gr√°fico con la tabla agrupada\n       aes(axis1 = Pclass,                  # Define el primer eje como sexo\n           axis2 = Sex,                     # Define el segundo eje como clase\n           axis3 = Survived,                # Define el tercer eje como supervivencia\n           y = n)) +                        # Usa la columna n para la altura de los estratos\n  geom_alluvium(aes(fill = Sex)) +          # A√±ade las corrientes (alluviums) o flujos coloreadas por sexo\n  geom_stratum() +                          # A√±ade los estratos (strata) o categor√≠as\n  geom_text(stat = \"stratum\",               # A√±ade etiquetas a los estratos \n            aes(label = after_stat(stratum))) +  # Usa el nombre del estrato como etiqueta\n  scale_x_discrete(limits = c(\"Pclass\", \"Sex\", \"Survived\"),  # Define los l√≠mites de los ejes x\n                   expand = c(.1, .1)) +     # A√±ade espacio alrededor de los ejes\n  scale_fill_viridis_d() +                   # Aplica una paleta de colores viridis\n  labs(title = \"  \", \n       y = \"Frecuencia\") +  \n  theme_minimal() +   \n  theme(legend.position = \"none\",  # Elimina la leyenda\n        axis.title.y = element_text(hjust = 1))   \n\nflujo  # Muestra el gr√°fico\n```\n\n::: {.cell-output-display}\n![](lab_session3_titanic_files/figure-html/flujo_superviencia_sexo_clase-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n\n\n\n\n::: {.callout-tip}\n## üìñ C√≥mo narrar una historia convincente con tus datos.\n\nHasta ahora hemos visto el **planteamiento**, en el que proporcionamos el contexto: un colega de departamento nos ha pedido ayuda. Si es cient√≠fico, como nosotros, podemos utilizar todo nuestro arsenal gr√°fico sin problemas. Como quiere hacer predicci√≥n, est√° interesado en ver la influencia de las variables en la `supervivencia`.\n\nEl an√°lisis exploratorio nos introduce de lleno en la **trama**, donde descubrimos que la `edad`, el `sexo` y la `clase` tienen influencia en la variable `supervivencia`.\n\nPero como siempre, lo m√°s importante es el **desenlace**, donde le estamos dando a nuestro colega las claves que necesita:\n\n-   Con el gr√°fico de flujo va a ver claramente como el sexo, la edad y la clase los tiene que tener en cuenta en el modelo: **la tercera clase tuvo un ratio de supervivencia claramente menor, al contrario que las mujeres y los ni√±os**.\n:::\n\n\n\n::: {.callout-tip}\n## Para pensar\n\nSi se hundiera hoy en d√≠a el Titanic, ¬øhabr√≠a cambiado la influencia de alguna variable en el modelo? ¬øTendr√≠amos una visualizaci√≥n m√°s confusa en el gr√°fico de flujo?\n\n¬øC√≥mo podr√≠a modelizarse la supervivencia, dadas las conclusiones que hemos sacado?\n:::",
    "supporting": [
      "lab_session3_titanic_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}