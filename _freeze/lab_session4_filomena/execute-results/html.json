{
  "hash": "3e5f87f2d97e1bcdee772b270647f215",
  "result": {
    "engine": "knitr",
    "markdown": "---\ntitle: \"Storytelling visual con R: primera clase\"\nsubtitle: \"Curso formativo para el PDI. Universidad de Castilla-La Mancha\"\nauthor:   \n  - name: Gema Fernández-Avilés \n    email: gema.faviles@uclm.es\n  - name: Isidro Hidalgo\n    email: isidro.hidalgo@uclm.es \ndate: \"2025-03-04\"\nformat:\n  html:\n    theme: cerulean\n    highlight-style: ayu-mirage\n    self-contained: true\n    lang: es\n    date-format: long\n    embed-resources: true\n    toc-title: Summary\n    toc: true\n    number-sections: true\n    preview-links: auto\n    code-link: true\nnumber-sections: true\nexecute:\n  echo: true\n  eval: true\n  output: true\n  include: true\n  freeze: auto\n  fig-height: 5\n  warning: false\n  comment: \"#>\"\n  code-line-numbers: true\n  code-copy: true\n  code-overflow: scroll\n---\n\n\n\n\n\n::: {.callout-warning}\n## IMPORTANTE\n\n**Como buen estudiante que eres, sabrás lo importante que es trabajar de forma autónoma y venir a clase con el material leído**. \n:::\n\n\n\n::: {.callout-note}\nLos datos que se utilizan en esta historia están disponibles en el paquete `CDR` que puede instalarse con el siguiente comando (se comprueba si no lo está):\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Instalación y/o carga del paquete `CDR`\"}\nif (!require(CDR)){\n  if (!require(remotes)) {install.packages(\"remotes\")}\n  remotes::install_github(\"cdr-book/CDR\")\n  }\n```\n:::\n\n\n\nLos datos referentes a la temperatura en España han sido recopilados por la Agencia Estatal de Meteorología (AEMET) y descargados en **R** con el paquete climatológico `climaemet`. Los mapas de España han sido procesados con el paquete `mapSpain`.\n:::\n\n# ¿Dónde se 'ha sufrido' más la borrasca Filomena?\n\nEl director de informativos de RTVE nos ha pedido al equipo de visualización que le preparemos un mapa rebonico para Informe Semanal. Como siempre, de un día para otro... ¡Que estamos a viernes por la tarde y ya me iba a ir a casica, con mi batica de Albacete! Que ya se sabe: \"¡Pijama y bata... calefacción barata!\".\n\n# Entender el contexto\n\n::: {.callout-tip}\n## Cómo definir el propósito y la audiencia de tu análisis\n\nEn este caso, está muy claro lo que nos piden: un mapa de España donde se pueda valorar fácilmente dónde ha sido más intensa la borrasca, por lo que directamente vamos a ir a visualizaciones basadas en el paquete `sf`, que nos permite usar geoestadística al más alto nivel y representar cualquier fenómeno espacialmente.\n\nComo siempre, vamos a empezar por explorar un poco los datos y después finalizaremos con la visualización espacial.\n:::\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Carga de libreías necesarías\"}\nlibrary(CDR)\nlibrary(tidyverse)\nlibrary(mapSpain)\nlibrary(sf)\nlibrary(GGally)\nlibrary(corrplot)\nlibrary(explore)\n```\n:::\n\n\n\n\n::: {.callout-warning}\n## CUIDADO: estamos trabajando con datos espaciales\n:::\n\nVisualizamos las primeras filas del dataset que vamos a utilizar `tempmin_data` ya creado y disponible en el paquete `CDR`.\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Mostramos las primeras filas del conjunto datos.\"}\n# CDR::tempmin_data\n\nhead(tempmin_data, 6)\n```\n\n::: {.cell-output .cell-output-stdout}\n\n```\n       fecha indicativo tmin  longitud  latitud\n1 2021-01-06      4358X -4.7 -5.880556 38.95556\n2 2021-01-06      4220X -7.0 -4.616389 39.08861\n3 2021-01-06      6106X  4.7 -4.748333 37.02944\n4 2021-01-06      9698U -6.8  0.865278 42.20528\n5 2021-01-06      4410X -3.4 -6.385556 38.91583\n6 2021-01-06      1331A  1.0 -7.031389 43.52472\n```\n\n\n:::\n:::\n\n\n\n# Elegir una visualización adecuada\n\n::: {.callout-tip}\n## Selección de gráficos y visualizaciones que mejor representen tus datos.\n:::\n\n## ¿Gráfico de cajas o de violines?\n\nAmbas soluciones son ideales para ver la distribución de las temperaturas mínimas. Recomendamos los violines porque son más informativos, ya que se ve mejor la distribución de las variables cuantitativas. Empecemos por el gráfico de cajas...\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Boxplot\"}\nggplot(tempmin_data, aes(x = fecha, y = tmin)) +\n  geom_boxplot(fill = \"orange\")\n```\n\n::: {.cell-output-display}\n![](lab_session4_filomena_files/figure-html/unnamed-chunk-4-1.png){width=672}\n:::\n:::\n\n\n\n## Mejora tu visualización con las herramientas disponibles\n\n¿Cómo podemos mejorar esta visualización? Ya hemos visto algunas:\n\n-   gráfico de violines\n\n-   título y subtítulo declarativos\n\n-   estética: color, anotaciones\n\nY por encima de todo: ¡simplicidad!\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Violin y boxplot\"}\nboxplot_inicial <- ggplot(tempmin_data,\n                          aes(x = fecha, y = tmin)) +\n  geom_violin(color = \"orange\") +\n  geom_boxplot(alpha = 0.6, \n               fill = \"orange\") +\n  labs(title = \"La borrasca Filomena fue más intensa el 6 de enero\",\n       x = \"Fecha\", \n       y = \"Temperatura mínima (°C)\") +\n  theme_minimal()\n\nboxplot_inicial\n```\n\n::: {.cell-output-display}\n![](lab_session4_filomena_files/figure-html/unnamed-chunk-5-1.png){width=672}\n:::\n:::\n\n\n\n## Simplificación\n\nBasta una primera mirada al gráfico para darnos cuenta de que las dos visualizaciones (caja y violín) aportan conjuntamente demasiada información. Por tanto, eliminamos elementos innecesarios del gráfico para enfocar la atención en lo que queremos destacar.\n\nPor eso, calculamos la mediana de las temperaturas y las conectamos temporalmente mediante un gráfico de línea, de forma que podamos indicar, no solo la distribución de la variable, sino también su evolución:\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Preparación de los datos\"}\nmedianas <- tempmin_data |>\n  select(fecha, tmin) |>\n  group_by(fecha) |>\n  mutate(mediana = median(tmin)) |>\n  select(fecha, mediana) |>\n  unique()\n\nmedianas$pos <- 1:5\n```\n:::\n\n\n\nAquí podríamos añadir los valores sobre el violín. En algunos casos, como cuando hay colas muy largas (aquí la inferior del día 7) es interesante ver si se debe a pocos valores o, por el contrario, hay que tenerlos en cuenta. Vamos a verlo:\n\n\n::: {.callout-important title=\"Tu turno\"}\nCompleta las partes del código señaladas por `_____` o `xxxxx` para obtener el resultado propuesto. ¿Te acuerdas de las funciones para explorar todas las variables a la vez?\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nboxplot_inicial <- ggplot(tempmin_data,\n                          aes(x = fecha, y = tmin)) +\n  geom_violin(color = \"orange\",              #  añade un violín\n              fill = \"orange\", \n              alpha = .7) +  \n  geom_point(data = medianas,                #  añade las medianas\n             aes(x = fecha, y = _______),      \n             color = \"darkblue\") +\n  geom_XXXX(data = medianas, \n            aes(x = pos, y = mediana),       #  añade una linea de conexión\n            color = \"darkblue\") +\n  geom_jitter(size = .2, \n              width = .2) +                   #  añade los puntos dispersos para evitar superposición\n  labs(title = \"Temperaturas mínimas durante la borrasca Filomena\",\n       ________ = \"6 de enero: día más frío (mediana en color azul)\",\n       x = \"Fecha\", \n       y = \"Temperatura mínima (°C)\") +\n  theme_minimal() \n\nboxplot_inicial\n```\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](lab_session4_filomena_files/figure-html/unnamed-chunk-8-1.png){width=672}\n:::\n:::\n\n\n\nSe ve claramente que las colas de los días 7 y 8 se deben casi exclusivamente a una estación, por lo que nuestra conclusión (y la que refleja la mediana) de etiquetar el día 6 como el peor, es acertada.\n\n::: {.callout-tip}\n## CUIDADO: es importante usar el argumento `size` en la función `geom_jitter` para hacer lo suficientemente pequeños los puntos y que no \"molesten\". Si se deja el valor por defecto (`size = 1`) aumentamos mucho el desorden. Para ver el efecto de los 2 parámetros, se pueden probar distintos valores y determinar los más estéticos.\n:::\n\n\n## Visualizaciones espaciales\n\nEn visualización, usando técnicas espaciales tenemos claramente las de ganar, porque tienen una estética muy atractiva *per se*.\n\n### Paso 1: Define y prepara los datos con un formato espacial\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Ponemos el objeto tempmin_data en formato espacial\"}\ntmin_sf <- st_as_sf(tempmin_data, \n                    coords = c(\"longitud\", \"latitud\"), \n                    crs = 4326)\n```\n:::\n\n\n\n\n### Paso 2: Utiliza las librerías para la representación espacial `sf` y `geof_sf`\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Primera representación tmin_sf\"}\nggplot() +\n  geom_sf(data = tmin_sf, \n          aes(color = tmin)) +\n  labs(title = \"Temperaturas mínimas (6-10 enero 2021)\",\n       x = \"Longitud\", y = \"Latitud\") \n```\n\n::: {.cell-output-display}\n![](lab_session4_filomena_files/figure-html/unnamed-chunk-10-1.png){width=672}\n:::\n:::\n\n\n\n\n\n### Paso 3: Añadimos un mapa de España con el paquete `mapSpain`\n\nAhora necesitamos un mapa de España y hacer unas comprobaciones\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Con la librería mapSpain cargamos el mapa de España sin las Islas Canarias  (por simplicidad)\"}\nesp <- esp_get_ccaa() |>\n  filter(ine.ccaa.name != \"Canarias\") # Filtramos las Islas Canarias\n```\n:::\n\n\n\n::: {.callout-warning}\n## ¿Están los datos de temperatura mínima en el mismo sistema de coordenadas que el mapa?\n:::\n\n::: {.callout-tip}\n## CRS: Un Sistema de Referencia de Coordenadas, o CRS, es un método para asociar coordenadas numéricas con una posición en la superficie de la Tierra.\n:::\n\nVerificamos que los sistemas de coordenadas de la capa de mapas de España (paquete `mapspain`) y de la capa de temperaturas mínimas (paquete `CDR`) sean los mismos; si no lo son, transformamos uno para igualarlos.\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Comprobación de los CRS de los datos y el mapa\"}\nif (st_crs(tmin_sf) != st_crs(esp)) {\n  esp <- st_transform(esp, st_crs(tmin_sf))\n}\n```\n:::\n\n\n\n\n### Paso 4: Seleccionamos el día más frío (6-enero)\n\nPuesto que el día de mayor intensidad general fue el 6 de enero, vamos a trabajar con esas temperaturas mínimas, representándolas en un mapa para ver las zonas más afectadas.\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ntmin_6enero <- tmin_sf |> \n  filter(fecha == \"2021-01-06\")\n\nmapa_inicial <- ggplot() +\n  geom_sf(data = esp, fill = \"grey95\") +\n  geom_sf(data = tmin_6enero, aes(color = tmin)) +\n  theme_dark()\n\nmapa_inicial \n```\n\n::: {.cell-output-display}\n![](lab_session4_filomena_files/figure-html/unnamed-chunk-13-1.png){width=672}\n:::\n:::\n\n\n\n::: {#exr-1}\n¿Qué podríamos hacer para mejorar esta visualización?\n:::\n\nAlgunas cosas que se pueden hacer:\n\n-   añadir un título (y subtítulo) declarativo interesante\n\n-   eliminar distracciones (por ejemplo el fondo)\n\n-   aumentar el tamaño de los puntos para que se aprecie mejor la gama de colores de la escala\n\n-   mejorar directamente los colores de la escala, para que se aprecien bien las diferencias\n\n::: {.callout-important title=\"Tu turno\"}\nCompleta las partes del código señaladas por `_____` o `xxxxx` para obtener el resultado propuesto.\n:::\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmapa_final <- ggplot() +\n  geom_xx(data = esp, fill = \"grey95\") +\n  geom_xx(data = ____________, aes(color = tmin), size = 3, alpha = 0.7) +\n  labs(title = \"Temperaturas mínimas durante la borrasca Filomena (6 de enero de 2021)\",\n       subtitle = \"Las temperaturas mínimas fueron más bajas en la España interior y zonas de montaña\",\n       color = \"Temperatura mínima (°C)\") +\n  scale_color_XXXXXXX_c() +\n  theme_minimal()\n\nmapa_final\n```\n:::\n\n::: {.cell}\n::: {.cell-output-display}\n![](lab_session4_filomena_files/figure-html/unnamed-chunk-15-1.png){width=672}\n:::\n:::\n\n\n\n### ¿Añadimos la dimensión temporal?\n\nPodemos usar facetas según el día en los que transcurrió la borrasca. Vamos a verlo.\n\n\n\n::: {.cell}\n::: {.cell-output-display}\n![](lab_session4_filomena_files/figure-html/unnamed-chunk-16-1.png){width=672}\n:::\n:::\n\n\n\n::: {.callout-tip}\n¿Qué os parece?¿Añade información interesante la dimensión temporal? ¿Y usando otra escala más acorde con nuestra idea de frío y calor?\n:::\n\nFijémonos lo que se puede hacer con una buena elección de escala. ¿Mejora la claridad y el impacto visual? ¿Se aprecian las diferencias temporales?\n\n\n\n::: {.cell}\n\n```{.r .cell-code  code-summary=\"Gráfico con la escala adecuada\"}\ncortes <- c(-Inf, seq(-20, 20, 2.5), Inf)       # Define los cortes para la escala de colores, desde -Inf a Inf con intervalos de 2.5\ncolores <- hcl.colors(15, \"PuOr\", rev = TRUE)  # Genera una paleta de colores con 15 colores usando la paleta \"PuOr\" y los revierte\n\nggplot() +                                    \n  geom_sf(data = esp, fill = \"grey95\") +      \n  geom_sf(data = tmin_sf, \n          aes(color = tmin), \n          size = 3, \n          alpha = 0.7) +  \n  facet_wrap(vars(fecha), \n             ncol = 3) +  \n  scale_color_gradientn(colours = colores,   # Aplica una escala de color con los colores \n                        breaks = cortes,     # Aplica una escala de cortes con los cortes definidos\n                        labels = ~ stringr::str_c(. , \"º\"),  # Añade etiquetas a los cortes, añadiendo el símbolo de grados\n                        guide = \"legend\") +  # Usa una leyenda para la guía de colores\n  theme_light() +  \n  labs(title = \"Temperaturas mínimas en España durante Filomena\",    \n       subtitle = \"Del 6 al 10 de enero de 2021\",   \n       color = \"Temp. mínima (°C)\")  \n```\n\n::: {.cell-output-display}\n![](lab_session4_filomena_files/figure-html/unnamed-chunk-17-1.png){width=672}\n:::\n:::\n\n\n\n# Contar una historia\n\n::: {.callout-tip}\n## Cómo narrar una historia convincente con tus datos.\n\nHemos visto el **planteamiento**, en el que proporcionamos el contexto: trabajamos para el director de informativos de RTVE, que nos ha pedido un mapa para presentarlo en las noticias.\n\nEl análisis exploratorio nos da una idea: el día más frío durante la borrasca Filomena fue el 6 de enero, por lo que ya tenemos qué información interesante debemos destacar.\n\nPero como remarcamos siempre, lo más importante es el **desenlace**, donde le estamos dando a nuestro director lo que nos pide:\n\n-   Un mapa donde se aprecia el **diferente impacto de la borrasca según la zona de España**...\n\n-   ...introduciendo la **dimensión temporal** con facetas.\n\n:::\n\n# Para pensar:\n\n::: {.callout}\nEn esta historia hemos visto lo importante que puede ser la **elección de una buena escala de colores**. \n\nMerece mucho la pena dedicar tiempo a la escala (intervalos y gama de colores), ya que, especialmente cuando hay gradientes continuos convertibles en categorías discretas, puede suponer acertar con la visualización o perder una buena oportunidad.\n:::\n\n\n",
    "supporting": [
      "lab_session4_filomena_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}