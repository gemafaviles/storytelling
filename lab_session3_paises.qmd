---
title: "Storytelling visual con R. Lab 3: demograf√≠a (cuantitativos)"
subtitle: "Curso formativo para el PDI. Universidad de Castilla-La Mancha"
author:   
  - name: Gema Fern√°ndez-Avil√©s 
    email: gema.faviles@uclm.es
  - name: Isidro Hidalgo
    email: isidro.hidalgo@uclm.es 
date: "`r Sys.Date()`"
format:
  html:
    theme: cerulean
    highlight-style: ayu-mirage
    self-contained: true
    lang: es
    date-format: long
    embed-resources: true
    toc-title: Summary
    toc: true
    number-sections: true
    preview-links: auto
    code-link: true
number-sections: true
execute:
  echo: true
  eval: true
  output: true
  include: true
  freeze: auto
  fig-height: 5
  warning: false
  comment: "#>"
  code-line-numbers: true
  code-copy: true
  code-overflow: scroll
---




::: {.callout-warning}
## IMPORTANTE

üìï **Como buen estudiante que eres, sabr√°s lo importante que es trabajar de forma aut√≥noma y venir a clase con el material le√≠do üòä**. 

ü¶Ñ <mark> Este icono indica **AVANZADO E IMPORTANTE**</mark>

:::


# Los datos

Los datos que se utilizan en esta historia est√°n disponibles en el repositorio GitHub "From data to viz": https://github.com/holtzy/data_to_viz. Adem√°s, se ha facilitado un archivo Excel



# ¬°Nos vamos a Noruega! ü•∂

¬°Ah, la vida del analista de datos! Mi jefe me ha pedido que realice un an√°lisis exploratorio (aunque en realidad siempre quiere gr√°ficos impresionantes con conclusiones fascinantes) de unos datos demogr√°ficos por pa√≠ses. Pero aqu√≠ viene lo mejor: quiere que lo acompa√±e a Noruega para un *workshop* "fant√°stico" [sic]...

Con el fr√≠o que hace ahora en Noruega, uno se pregunta: ¬øpor qu√© no elige destinos con m√°s criterio? ¬°Haw√°i, por ejemplo, ser√≠a una opci√≥n mucho m√°s c√°lida y agradable!



::: {.callout-tip}

## Entender el contexto: c√≥mo definir el prop√≥sito y la audiencia de tu an√°lisis

En este caso, lo que me pide el jefe es un an√°lisis exploratorio. B√°sicamente, se trata de encontrar relaciones interesantes entre variables, observar su evoluci√≥n para ver si surge algo llamativo, y preparar gr√°ficos que vayan al grano, como ya sabemos hacer... 

üéì ¬°Para eso sirven los cursos de la UCLM
:::


**Paso (i):** Lectura de paquetes

```{r}
library(tidyverse)
library(psych)
library(GGally)
library(corrplot)
library(plotly)
```


**Paso (ii):** Lectura de los datos 

+ Opci√≥n (a): Lectura de datos formato `csv` directamente desde la web
```{r}
#| eval: false
demog_data <- read.table("https://raw.githubusercontent.com/holtzy/data_to_viz/master/Example_dataset/multivariate.csv", header = T, sep = ";")
```

+ Opci√≥n (b): Lectura de datos formato `csv` (recuerda que mis datos est√°n guardados en la carpeta `data`, ¬ølos tuyos tambi√©n o no?)
```{r}
demog_data <- read.table("data/multivariate.csv", header = T, sep = ";")
```


::: {.callout-warning title="Tu turno"}
## Tu turno

Completa las partes del c√≥digo se√±aladas por `_____` o `xxxxx` para obtener el resultado propuesto y acu√©rdate de cambiar `eval: false` por `eval: true` cuando lo hayas cumplimentado para que se ejecute correctamente la chunk.
:::



# ¬øC√≥mo son mis datos?

**Paso 1** Muestra las primeras filas del conjunto de datos `demog_data`.

```{r}
#| eval: false
head(_______)
```


**Paso 2** Echa un vistazo a la estructura de las variables con la funci√≥n `glimpse()`.

```{r}
#| eval: false
________(demog_data)
```


**Paso 3** Haz unos descriptivos b√°sicos con la funci√≥n `describe()` del paquete `psych`.

```{r}
#| eval: false
________(demog_data)
```


**Paso 4** Aqu√≠ va otra opci√≥n interesante con la funci√≥n `skim()` del paquete `skim`.

```{r}
skimr::skim(demog_data)
```



# Elegir una visualizaci√≥n adecuada

::: {.callout-tip}
## Selecci√≥n de gr√°ficos y visualizaciones que mejor representen tus datos. En este caso la mayor√≠a son variables cuantitativas.
:::

üìä  **Matriz diagramas de dispersi√≥n** (*scatterplot matrix*)

Podemos comenzar por una matriz de puntos de las variables cuantitativas. El paquete `GGally` ofrece una visualizaci√≥n muy elaborada para un primer vistazo con la funci√≥n `ggpairs()`.

::: {.callout-tip}
## Cuidado: solo variables cuantitativas.
:::


**Paso 1**  Selecciona las variables cuantitativas del conjunto de datos `demog_data` y guardarlas en el objeto `demo_cuanti`. 

```{r}
demo_cuanti <- demog_data |>
   select(Pop, Birth_rate, Mortality_rate, Life_expectancy,
          Infant_mortality, Child_per_woman,  Growth_rate,
          Pop_aged_65) |>
   na.omit()
```


**Paso 2** **Matriz de correlaciones y diagramas de dispersi√≥n** con la funci√≥n `ggpairs()` de la librer√≠a `GGally`

```{r}
demo_cuanti |> 
   ggpairs(progress = FALSE)
```

üìä  **Matriz de correlaciones** 

Hay muchas asociaciones interesantes entre diferentes variables. Aqu√≠ ya vemos mucha tela que cortar. Por no extendernos, analizaremos una de las relaciones m√°s adelante. Pero primero, es muy interesante ver la matriz de correlaciones que, aunque con `ggpairs()` ten√≠amos ya una primera impresi√≥n, el paquete `corrplot` nos ofrece una visualizaci√≥n ideal con la funci√≥n `corrplot.mixed()`


**Paso 3** Primero calculo la matriz de correlaciones con la funci√≥n `cor()` y luego la represento con la funci√≥n `corrplot.mixed()` que presenta m√∫ltiples posibilidades.

```{r}
demo_cuanti |> 
  cor() |> 
  corrplot.mixed( order = 'AOE')
```


üìä  **Gr√°fico de puntos o scatterplot** 


Como ejemplo, vamos a ver la relaci√≥n entre la tasa de crecimiento, `Growth_rate`, y la esperanza de vida, `Life_expectancy`, que ya hemos visto que existe relaci√≥n estad√≠stica. Empecemos con diagrama de puntos.


**Paso 4** ¬øTe acuerdas de la funci√≥n de `ggplot2` para una capa de puntos?

```{r}
#| eval: false
ggplot(demog_data,
         aes(x = Growth_rate, y = Life_expectancy)) +
  geom_xxxxxxxx() +
  labs(title = "Esperanza de vida vs. Tasa de crecimiento",
       x = "Tasa de crecimiento",
       y = "Esperanza de vida") +
  theme_minimal()
```



üìä  **Hexbin plot** 

**Paso 5** ¬øTe acuerdas de la funci√≥n de `ggplot2` para convertir puntos en densidades de forma hexagonal?
```{r}
#| eval: false
ggplot(demog_data,
       aes(x = Growth_rate, y = Life_expectancy)) +
  geom_xxx() +
  labs(title = "Esperanza de vida vs. Tasa de crecimiento",
       x = "Tasa de crecimiento",
       y = "Esperanza de vida") +
  theme_minimal()
```


üîç **Eliminar el desorden. Enfocar la atenci√≥n**

¬øQu√© herramientas tenemos a nuestro alcance para poner el foco sobre lo que nos interesa? Aqu√≠ podemos usar la est√©tica y las facetas, para separar los puntos y dar m√°s informaci√≥n a trav√©s de la visualizaci√≥n. Veamos...


**Paso 5** Diagrama de dispersi√≥n mejorado por est√©tica incluyendo la variable `Pop` para el tama√±o de los puntos.

```{r}
#| eval: false
  ggplot(demog_data,
         aes(x = Growth_rate, y = Life_expectancy, 
             _____ = Pop)) +
  scale_size(range = c(.1, 20)) +
  labs(title = "Esperanza de vida vs. Tasa de crecimiento",
       x = "Tasa de crecimiento",
       y = "Esperanza de vida") +
  theme_minimal() 
```


**Paso 6** A√±ade la variable `Continent` en el an√°lisis para representar por colores los continentes en la est√©tica de la funci√≥n `aes()`. Adem√°s, a√±ade cierta transparencia porque puede que los puntos m√°s grandes est√©n tapando a los m√°s peque√±os. Escribe el t√≠tulo que consideres m√°s apropiado. Ahora, el gr√°fico lo vamos a guardar en un objeto llamado `g_demog`.


```{r}
#| eval: false
g_demog <- ggplot(demog_data,
         aes(x = Growth_rate, y = Life_expectancy, 
             _____ = Pop,
             _____ = Continent)) +
  geom_point(_____ = 0.5) +
  scale_size(range = c(.1, 20)) +
  labs(title = "_______________________________",
       x = "Tasa de crecimiento",
       y = "Esperanza de vida") +
  theme_minimal() 

# para represenar el gr√°fico

g_demog
```


üìä  **Gr√°ficos interactivos** 

**Paso 7** Hacemos interactivo el gr√°fico anterior con la funci√≥n `ggplotly()` de la libreri√° `pltoly`.

```{r}
#| eval: false
ggplotly(_____)
```


Estamos usando **dos variables para enfocar la atenci√≥n aportando informaci√≥n: el tama√±o del pa√≠s y el continente**. Solo con eso vemos enseguida por donde van los tiros: la mayor parte de los pa√≠ses de Europa tienen gran esperanza de vida y crecimiento moderado. Por el contrario, Sudam√©rica tiene tasas de crecimiento muy elevadas (son pa√≠ses en fases de expansi√≥n econ√≥mica) y una menor esperanza de vida, a falta de consolidar sanidad y otros servicios en general.

Tambi√©n somos capaces de identificar China e India r√°pidamente, por su tama√±o, y Jap√≥n arriba a la izquierda por su tama√±o medio-grande y enorme esperanza de vida.

Sin embargo, hay colores muy parecidos, que exigen demasiada atenci√≥n. Podemos usar la siguiente herramienta...

 

üìä  **Facetas** 

Otra forma de eliminar el desorden y enfocar la atenci√≥n es usar facetas, separando el gr√°fico seg√∫n una o m√°s variables interesantes. En este caso usamos solo el continente.


ü¶Ñ **Paso 8** Diagrama de dispersi√≥n mejorado por facetas con la funci√≥n `facet_wrap()`.

```{r}
demog_scatter <- ggplot(data = demog_data, # data
              aes(x = Growth_rate, y = Life_expectancy, colour = Continent)) + #aesthetics
    geom_point(alpha = 0.5) + #geometries
    facet_wrap(~ Continent, scales = "free") + #facets
    labs(title = "Life expectancy at birth vs. Per capita GDP", 
         x = "Growth_rate", y = "Life_expectancy", colour = "Continent") + #labels
    theme_light() #themes

demog_scatter 
```

‚ùì **¬øQu√© problema podr√≠a tener este gr√°fico?**

::: {.callout-tip}
## Pista

¬°Fijaos en los ejes!
:::

Exacto: las escalas. Pero hemos dicho "podr√≠a", no que tenga un problema en s√≠. Cuando nuestra intenci√≥n es mirar dentro de cada faceta para ver la relaci√≥n entre las variables, es posible que nos interese dejarlo como est√°.

Pero muchas veces es muy importante, cuando usamos facetas, que podamos comparar los diferentes grupos entre s√≠. En este caso, es imprescindible usar la misma escala en todas las facetas. Para ello, hay que especificar los l√≠mites de las escalas de los ejes.

¬øExiste una forma f√°cil de saber cu√°les poner? Claro, con un `summary()` de las variables, tal como indicamos a continuaci√≥n, vemos r√°pidamente el valor m√≠nimo y m√°ximo de las variables que nos interesan:


ü¶Ñ **Paso 9 ** Mejoramos la escala para comparar facetas: observamos los l√≠mites de las variables.
```{r}
summary(demog_data$Life_expectancy)
summary(demog_data$Growth_rate)
```


ü¶Ñ **Paso 10** Especificamos los l√≠mites en los 
```{r}
demog_scatter_escala <- ggplot(data = demog_data,
                               aes(x = Growth_rate,
                                   y = Life_expectancy,
                                   colour = Continent)) +
  geom_point(alpha = 0.5) +
  facet_wrap(~ Continent, scales = "free") +
  labs(title = "Esperanza de vida respecto al PIB per capita",
       x = "Tasa de crecimiento", y = "Esperanza de vida",
       colour = "Continent") +
  scale_x_continuous(limits = c(-10, 45)) +
  scale_y_continuous(limits = c(45, 85)) +
  theme_light()

demog_scatter_escala 
```



üìà **Linea de suavizado**

A veces, si hay una tendencia evidente, es conveniente usar una l√≠nea de suavizado que la identifique. En este caso, no est√° nada clara, por lo que la podemos omitir. Y aqu√≠ s√≠ es interesante dejar libre la escala, para maximizar la visualizaci√≥n de la tendencia, que es lo que nos interesa.

**Paso 11**  A√±adimos l√≠nea de suavizado con la funci√≥n `geom_smooth()`.

```{r}
#| eval: false
______ + geom_smooth(method = NULL, se = TRUE) 
```


::: {.callout-tip}
## C√≥mo narrar una historia convincente con tus datos.

Hemos visto el **planteamiento**, en el que proporcionamos el contexto: trabajamos para un jefe que nos ha pedido algo muy concreto: un an√°lisis exploratorio (y sabemos que lo quiere con conclusiones)...

El an√°lisis exploratorio podemos usarlo para ir introduciendo la **trama**, donde vemos enseguida relaciones interesantes entre algunas parejas de variables... Solo hemos analizado la esperanza de vida al nacer respecto a la tasa de crecimiento, pero en la matriz de puntos hemos visto muchas, por lo que el jefe estar√° feliz.

La segmentaci√≥n tambi√©n nos ha proporcionado agrupaciones de pa√≠ses, aunque visualmente son dif√≠ciles de interpretar, por lo que lo m√°s l√≥gico ser√≠a seleccionar un conjunto de pa√≠ses de inter√©s, que consiga un an√°lisis (y su visualizaci√≥n) m√°s interesante.

Como siempre, lo m√°s importante es el **desenlace**, donde le estamos dando a nuestro jefe las claves que necesita:

-   La matriz de puntos es vital, si nuestro superior est√° habituado al an√°lisis, porque **se aprecia un n√∫mero importante de relaciones claras entre variables**.

-   En cada variable **podemos usar la est√©tica y las facetas para potenciar la visualizaci√≥n**, determinando las variables que suministran informaci√≥n en las relaciones encontradas.

Finalmente, hemos visto que, cuando tenemos un n√∫mero elevado de informaci√≥n, tenemos que adoptar una decisi√≥n equilibrada entre la informaci√≥n que suministramos en nuestros gr√°ficos y nuestra habilidad para eliminar el desorden y enfocar la mirada del espectador a lo que nos interesa m√°s. Para el caso que nos ocupa, podemos:

-   Usar la agrupaci√≥n previa por zonas geogr√°ficas, como hemos hecho antes.

-   Restringir la visualizaci√≥n a una zona geogr√°fica concreta.

-   Filtrar determinados pa√≠ses para quedarnos con los que nos interesa comparar.

-   Directamente usar una tabla, relacionando todos los pa√≠ses de inter√©s.
:::

![](img/logos_finan.png){align="right"}
