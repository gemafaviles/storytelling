---
title: "Storytelling visual con R. Lab 4. Accidentalidad üöò"
subtitle: "¬øC√≥mo y d√≥nde se producen los accidentes en Madrid?"
author:   
  - name: Gema Fern√°ndez-Avil√©s 
    email: gema.faviles@uclm.es
  - name: Isidro Hidalgo
    email: isidro.hidalgo@uclm.es 
date: "`r Sys.Date()`"
format:
  html:
    theme: cerulean
    highlight-style: ayu-mirage
    self-contained: true
    lang: es
    date-format: long
    embed-resources: true
    toc-title: Summary
    toc: true
    number-sections: true
    preview-links: auto
    code-link: true
number-sections: true
execute:
  echo: true
  eval: true
  output: true
  include: true
  freeze: auto
  fig-height: 5
  warning: false
  comment: "#>"
  code-line-numbers: true
  code-copy: true
  code-overflow: scroll
---



::: {.callout-warning}
## IMPORTANTE

üìï **Como buen estudiante que eres, sabr√°s lo importante que es trabajar de forma aut√≥noma y venir a clase con el material le√≠do üòä**. 

ü¶Ñ <mark> Este icono indica **AVANZADO E IMPORTANTE**</mark>

:::


# Los datos

Los datos con los que vamos a trabajar se corresponden con los accidentes de tr√°fico en la Ciudad de Madrid registrados por Polic√≠a Municipal con v√≠ctimas y/o da√±os al patrimonio en el a√±o 2020. Los datos se han descargado del [Portal de datos abiertos del Ayuntamiento de Madrid.](https://datos.madrid.es/portal/site/egob/menuitem.c05c1f754a33a9fbe4b2e4b284f1a5a0/?vgnextoid=7c2843010d9c3610VgnVCM2000001f4a900aRCRD&vgnextchannel=374512b9ace9f310VgnVCM100000171f5a0aRCRD&vgnextfmt=default))


# El jefe quiere verte üò±

Esta ma√±ana, mientras disfrutaba de una tranquila jornada en mi oficina (trabajo en el distrito de Chamart√≠n para el Ayuntamiento de Madrid), me sueltan de repente: "el jefe quiere verte". Lo primero que pens√© fue que me iban a despedir, ya que tengo fama de ser un poco "cansa almas"... Pero no, entro en el despacho del jefe... ¬°Y all√≠ est√° Almeida! Resulta que ha o√≠do que hice un curso de visualizaci√≥n en la UCLM y me he convertido en un crack de la visualizaci√≥n. Yo no sab√≠a d√≥nde meterme, pero mantuve la compostura como todo un profesional.

Almeida me cont√≥ que est√° muy preocupado por los accidentes y quiere analizar el tema para buscar soluciones. Me agradecer√≠a mucho si encontramos d√≥nde est√° el problema, para reducir el n√∫mero y la gravedad de los accidentes en la ciudad. El √∫nico inconveniente, me dice, es que solo puede facilitarme los datos del a√±o 2020. Ya le advert√≠ que es un a√±o muy particular debido al estado de alarma, pero algo sacaremos...

¬°As√≠ que manos a la obra! Vamos a demostrar nuestras habilidades de storytelling visual con R y ayudar a mejorar la seguridad en nuestra querida ciudad. üö¶üìä



::: {.callout-tip}
## Entender el contexto: ¬øC√≥mo definir el prop√≥sito y la audiencia de tu an√°lisis?

¬øQu√© le interesa al alcalde? Reducir la tasa de accidentes, por supuesto. Pero desde el punto de vista de la visualizaci√≥n, est√° claro que va a necesitar **informaci√≥n georreferenciada**, as√≠ que prepararemos unos mapas espectaculares. Adem√°s, la **dimensi√≥n temporal** es crucial, porque no es lo mismo Madrid en agosto que un d√≠a de lluvia o en pleno calendario escolar... Y, por supuesto, tambi√©n analizaremos el **tipo de accidente**.

En cualquier caso, lo primero es realizar un an√°lisis exploratorio para detectar cualquier anomal√≠a en los datos y analizar m√≠nimamente las variables de inter√©s. Despu√©s, prepararemos los gr√°ficos necesarios para **aportarle conocimiento** sobre los accidentes en la ciudad.
:::


::: {.callout-tip}
## Elegir una visualizaci√≥n adecuada

Selecci√≥n de gr√°ficos y visualizaciones que mejor representen tus datos en cada momento. 
:::




**Paso (i):** Lectura de paquetes

```{r}
library(tidyverse)         # Para manipulaci√≥n y visualizaci√≥n de datos
library(sf)                # Para datos espaciales
library(mapSpain)          # Para obtener y visualizar mapas de Espa√±a
library(tidyterra)         # Para trabajar con datos espaciales y raster
library(leaflet)           # Para crear mapas interactivos
library(leaflet.extras)    # Para funcionalidades adicionales en leaflet
```

**Paso (ii):** Lectura de los datos (recuerda que mis datos est√°n guardados en la carpeta `data`, ¬ølos tuyos tambi√©n o no?)

```{r}
accidentes2020_data <- read.table("data/accidentes_sin_duplicados.txt")
```


**Paso (iii):** Descripci√≥n de las variables con la informaci√≥n contenida en el paquete `CDR`.

```{r}
#| eval: false

if (!require(CDR)){
  if (!require(remotes)) {install.packages("remotes")}
  remotes::install_github("cdr-book/CDR")
}

help(accidentes2020_data)
```


::: {.callout-warning title="Tu turno"}
## Tu turno
Completa las partes del c√≥digo se√±aladas por `_____` o `xxxxx` para obtener el resultado deseado y acu√©rdate de cambiar `eval: false` por `eval: true` cuando lo hayas cumplimentado para que se ejecute correctamente la chunk.
:::



# ¬øC√≥mo? ¬øDe qu√© tipo son los accidentes? 


**Paso 1** Muestra las primeras filas del conjunto de datos `accidentes2020_data`.
```{r}
#| eval: false
_____(________)
```


**Paso 2** Echa un vistazo a la estructura de las variables con la funci√≥n `glimpse()`.
```{r}
#| eval: false
_____(accidentes2020_data)
```


**Paso 3** Convierte las variables caracteres a factores con la funci√≥n `mutate_if()`.
```{r}
accidentes2020_data <- accidentes2020_data |>
  mutate_if(is.character, as.factor)
```

**Paso 4** Resumen num√©rico por tipo de accidente `tipo_accidente`.
```{r}
accidentes2020_data |>
  count(tipo_accidente) |>
  mutate(porcentaje = n / sum(n) * 100) 
```


Las tablas tambi√©n son elementos de visualizaci√≥n. En este caso, hay algo evidente que hacer. Lo vamos a explicar con el siguiente gr√°fico.

**Paso 5** Gr√°fico de barras por `tipo_accidente` en el eje `y`.

```{r}
#| eval: false

accidentes2020_data |>
  ggplot() +
  geom_xxx(aes(y = _________))
```





‚ùì **¬øQu√© le falta a este gr√°fico? ¬øEn qu√© se puede mejorar?**

Pues est√° muy claro: 

* cambia la **est√©tica**: dale color `orange` al relleno de las barras y transparencia de `0.6`,
* modifica el **fondo** con el tema `theme_bw()` y, 
* lo m√°s importante, **ordena las categor√≠as**. Si no est√°n ordenadas tardamos mucho en determinar, por ejemplo, cu√°l es la tercera, o la quinta... √önicamente, la m√°s importante es relativamente f√°cil de situar. 

**Paso 6** Gr√°fico de barras por tipo de accidente ordenado
```{r}
#| eval: false
ggplot(accidentes2020_data, 
       aes(y = reorder(tipo_accidente,  
                       - tipo_accidente,      # Reordena tipos_accidente en orden descendente
                       length))) +            # Usa la longitud para el reordenamiento
  geom_bar(fill = "________", alpha = ___) +  
  theme_xx()   
```


Adem√°s, deber√≠amos especificar un t√≠tulo y unas etiquetas a los ejes x e y.

**Paso 7** El t√≠tulo: `Tipos ccidentes en Madrid durante el a√±o 2020` y la etiqueta del eje x (`N√∫mero de accidentes`). ¬øEs necesaria la etiqueta del eje y?
```{r}
#| eval: false
ggplot(accidentes2020_data, 
       aes(y = reorder(tipo_accidente,  
                       - tipo_accidente, # Reordena tipos_accidente
                       length))) +       # Usa la longitud para el reordenamiento
  geom_bar(fill = "orange", alpha = 0.6) +                    
  labs(title = "_____________",   
       x = "_______", 
       y = " ") +  
  theme_bw()   
```

‚ùì **¬øSe podr√≠a hacer r√°pidamente un lollipop con las frecuencias relativas (datos en porcentaje)?** 

ü¶Ñ **Paso 7** **Lollipop** ordenado con `geom_segment()` y `geom_point()`
```{r}
# Calcular la frecuencia de cada tipo de accidente
accidentes2020_data |>
  count(tipo_accidente) |>
  mutate(porcentaje = n / sum(n) * 100) |>
# Crear el gr√°fico de lollipop 
ggplot(aes(y = reorder(tipo_accidente, porcentaje), x = porcentaje)) + 
  geom_segment(aes(yend = tipo_accidente, xend = 0), 
               color = "blue", alpha = 0.5) + 
  geom_point(color = "blue", 
             size = 4, 
             alpha = 0.6) + 
  labs(title = "Tipos ccidentes en Madrid durante el a√±o 2020", 
       y = " ", 
       x = "Porcentaje") + 
  theme_minimal()

```



# ¬øCu√°ndo? ¬øCu√°ndo se han producido los accidentes? 

Es crucial conocer cu√°ndo ocurrieron los hechos, especialmente si hablamos de un a√±o tan singular como el 2020, marcado por el confinamiento y el estado de alarma. En fin, mejor no recordar m√°s detalles.

Adem√°s, sabemos *a priori* que la fecha influye en el aumento del tr√°fico, por lo que es probable que encontremos alg√∫n impacto de la dimensi√≥n temporal. Vamos a investigarlo...



**Paso 1** Primer gr√°fico del cu√°ndo
```{r}
ggplot(data = accidentes2020_data,
       aes(x = fecha, y = hora)) + 
  geom_point() +
  theme_minimal()
```



Vamos a separar la fecha y la hora, porque en ese gr√°fico no vemos casi nada... Pare ello usaremos la funci√≥n `as.Date()` especificando el formato adecuado en el que se encuentran nuestros datos, en este caso `%d/%m/%Y`, es decir, d√≠a/mes/a√±o.

**Paso 2** Prepara los datos teniendo en cuenta la dimensi√≥n temporal. Convierte la columna `fecha` a formato `Date` con la funci√≥n `as.Date`.
```{r}
accidentes2020_data$fecha <- as.Date(accidentes2020_data$fecha, format = "%d/%m/%Y")
```


üìà **Gr√°fico del cu√°ndo seg√∫n el d√≠a**

**Paso 3** Crea un nuevo conjunto de datos `accidentes2020_fecha` donde cada d√≠a contenga el n√∫mero de accidentes ocurridos
```{r}
#| eval: false
____________ <- accidentes2020_data |>
  group_by(fecha) |>
  summarise(n = n()) |>
  ungroup()
```



**Paso 4** ¬øQu√© tipo de gr√°fico ser√≠a apropiado? ¬øDe barras `geom_bar`? ¬øDe lineas `geom_line`? ¬øDe puntos `geom_point`?
```{r}
#| eval: false
ggplot(data = accidentes2020_fecha,   
       aes(x = fecha, y = n)) +       
  geom_xxxx() +                      
  theme_minimal()                     
```

Como ya le advertimos al alcalde, el a√±o 2020 no es bueno para sacar conclusiones. Ya le hemos pedido que nos facilite datos m√°s amplios para poder proporcionarle una mejor visualizaci√≥n del n√∫mero de accidentes por fecha, pero mientras tanto, nos tendremos que arreglar con lo que tenemos...



üìà **Gr√°fico del cu√°ndo seg√∫n la hora**

**Paso 5** Convierte la columna `hora` a formato `POSIXct` y extrae la hora del d√≠a con la funci√≥n `hour()`
```{r}
accidentes2020_data$hora_dia <- hour(as.POSIXct(accidentes2020_data$hora, format = "%H:%M:%S"))
```

**Paso 6** Crea un nuevo conjunto de datos `accidentes2020_hora_dia` 

```{r}
accidentes2020_hora_dia <- accidentes2020_data |>  # Crea el dataset accidentes2020_hora_dia
  group_by(hora_dia) |>                            # Agrupa los datos por hora_dia
  summarise(n = n()) |>                               # Crea una nueva columna n con el conteo de accidentes por hora
  ungroup()                                         # Elimina duplicados
```


**Paso 7** Dibuja el numero de accidentes `n` seg√∫n la hora del d√≠a `hora_dia`.
```{r}
#| eval: false
ggplot(data = accidentes2020_hora_dia,             
       aes(x = hora_dia, y = n)) +                 # x= hora_dia e  y=n  
  geom_xxxx(linewidth = _____,      # Ancho de la l√≠nea  ____
            color = "______") +     # A√±ade una l√≠nea de color ______ 
  labs(title = "N√∫mero de accidentes seg√∫n la horaria del d√≠a",   
       x = "Hora", 
       y = "N√∫mero de accidentes") +   
  theme_minimal()   
```



# ¬øD√≥nde? ¬øD√≥nde se han producido los accidentes de tr√°fico en Madrid en el 2020?

Conocer las coordenadas exactas donde se ha producido un accidente de tr√°fico es de vital importancia para la seguridad vial. Esta informaci√≥n nos permite identificar y analizar los llamados "puntos negros", es decir, √°reas donde se concentran un alto n√∫mero de accidentes. Al detectar estos puntos cr√≠ticos, las autoridades pueden implementar medidas espec√≠ficas, como mejorar la se√±alizaci√≥n, redise√±ar la infraestructura vial o aumentar la vigilancia, para reducir la incidencia de accidentes. 

Adem√°s, el an√°lisis geoespacial de los accidentes facilita la toma de decisiones informadas y la asignaci√≥n eficiente de recursos para mejorar la seguridad en las zonas m√°s peligrosas. En resumen, la georreferenciaci√≥n de los accidentes es una herramienta esencial para mostrar al alcalde Almeida.

**Paso 1** Primer mapa de localizaci√≥n de los accidentes  con las variables `coordenada_x_utm` y `coordenada_y_utm`.
```{r}
#| eval: false
ggplot(data = accidentes2020_data,                          
       aes(x = ___________, y = _____________ )) +    
  geom_xxxxxx()                                              
```


üé∞ El desorden es tu enemigo

Deja mucho que desear, ¬øverdad? Recuerda, **el desorden es tu enemigo**. En este momento, solo tenemos puntos representados en un gr√°fico, no informaci√≥n √∫til. Con unos peque√±os ajustes, como mejorar la est√©tica (reduciendo el tama√±o de los puntos para que se vea el fondo) y a√±adir una referencia geogr√°fica (como un mapa de carreteras), podremos reducir la carga cognitiva y hacer el gr√°fico m√°s comprensible.

::: {.callout-warning}
## CUIDADO: estamos trabajando con datos **especiales**, datos **espaciales**. 

Los datos espaciales tienen caracter√≠stica importantes que debemos tener en cuenta. Aqu√≠, repasamos r√°pidamente los conceptos m√°s importantes:

+ **Proyecci√≥n**: La Tierra es una esfera en 3D y nosotros la vamos a proyectar en un plano 2D.

+ **CRS**: Un Sistema de Referencia de Coordenadas, o CRS, es un m√©todo para asociar coordenadas num√©ricas con una posici√≥n en la superficie de la Tierra.

+ **R-spatial**: para trabajar con datos espaciales en **R** contamos con la librer√≠a `sf` y otras que nos proporcionar√°n mapas.
:::



ü¶Ñ **Paso 2**  Convierte el dataset accidentes2020_data a un objeto `sf`.
```{r}
accidentes2020_sf <- st_as_sf(accidentes2020_data,     
  coords = c("coordenada_x_utm", "coordenada_y_utm"),  # Define las columnas de coordenadas UTM
  crs = 25830                                          # Establece el sistema de referencia de coordenadas a ETRS89/UTM zona 30N, usado en Europa
)
```


ü¶Ñ **Paso 3** Obtiene datos del municipio de Madrid con la funci√≥n `esp_get_munic()` de la librer√≠a `mapSpain`.
```{r}
madrid <- esp_get_munic(munic = "^Madrid$") |>    # Obtiene los datos del municipio de Madrid
  st_transform(25830)                             # Transforma las coordenadas al sistema de referencia ETRS89/UTM zona 30N

madrid
class(madrid)
```


ü¶Ñ **Paso 4** Descarga una imagen de un mapa est√°tico de las carreteras de Madrid con la funci√≥n `esp_getTiles()` de la librer√≠a `mapSpain`
```{r}
tile <- esp_getTiles(madrid, "IDErioja", zoommin = 2)
```


ü¶Ñ **Paso 5** Primer mapa mejorado con la funci√≥n `ggplot()` (nada nuevo üòâ). A√±ade la imagen del mapa de carreteras de fondo con la funci√≥n `geom_spatraster_rgb()` del paquete `tidyterra` y especifica la est√©tica (hazlo a tu gusto).

```{r}
#| eval: false
ggplot() +                                     # Inicia un gr√°fico vac√≠o con ggplot
  geom_spatraster_rgb(data = tile) +           # A√±ade la imagen del mapa est√°tico como fondo
  geom_sf(data = accidentes2020_sf,            # A√±ade los datos de accidentes como puntos en el mapa
    col = "______",                            # Define el color de los puntos
    size = ___,                                # Define es tama√±o de los puntos (0.05)
    alpha = __) +                              # Define la transparencia de los puntos
  coord_sf(expand = FALSE) +                   # Mantiene las proporciones de las coordenadas sin expansi√≥n
  labs(title = "________________")             # T√≠tulo
```

¬°Esto ya es otra cosa! Apreciamos, l√≥gicamente, la concentraci√≥n de accidentes en el centro de la ciudad y, especialmente, en las arterias principales.



üó∫ **Mapas interactivos**

Una categor√≠a especial, y que merece mucho la pena destacar, cuando tenemos informaci√≥n georreferenciada, son los mapas interactivos. Una de las librer√≠as m√°s populares para construirlos en **R** es `leaflet`. Este paquete permite crear mapas din√°micos e interactivos utilizando la librer√≠a Leaflet de JavaScript. La principal ventaja de utilizar `leaflet` frente a otras alternativas es su flexibilidad y que su implementaci√≥n en **R** es realmente sencilla de usar.


ü¶Ñ **Paso 6** Preparaci√≥n de los datos. Transforma el CRS de `accidentes2020_sf` a WGS 84 (**CRS 4326**), CRS usado en Google Earth y en los sistemas GSP (longitud, latitud).

```{r}
accidentes2020_sf <- st_transform(accidentes2020_sf, crs = 4326)
```


ü¶Ñ **Paso 7** Extrae las coordenadas de longitud y latitud del objeto espacial proyectado `accidentes2020_sf` y las a√±ade como una nuevas columnas, nuevas variables, `longitude` y `latitude`, en el conjunto de datos `accidentes2020_data`.

```{r}
accidentes2020_data$longitude <- st_coordinates(accidentes2020_sf)[, 1]  
accidentes2020_data$latitude <- st_coordinates(accidentes2020_sf)[, 2]
```


ü¶Ñ **Paso 8** Primer mapa interactivo con `leaflet`
```{r}
leaflet(data = accidentes2020_data) |>  # Crea un mapa interactivo con el dataset accidentes2020_data
  addTiles() |>                         # A√±ade las teselas (tiles) del mapa base
  addCircleMarkers(lng = ~longitude, lat = ~latitude,          # A√±ade marcadores circulares en lon y lat
                   radius = 1,                                 # Define el radio, 
                   color = "red",                              # Define el color   
                   opacity = 0.5                               # Define la opacidad de los marcadores
                   )   
#  addProviderTiles(providers$Esri.WorldImagery)
```



üé® **Piensa como un dise√±ador**

Estas visualizaciones est√°n muy bien pero... ¬øy si pudi√©ramos aminorar la carga cognitiva del mapa interactivo? Una forma de hacerlo es **usar agrupaciones**. Veamos c√≥mo hacerlo.

ü¶Ñ **Paso 9** Primer mapa interactivo con `leaflet` y clusters con la funci√≥n `addCircleMarkers()`
```{r}
leaflet(data = accidentes2020_data) |>
  addTiles() |>
  addCircleMarkers(lng = ~longitude, 
                   lat = ~latitude, 
                   clusterOptions = markerClusterOptions()
                   )
```


ü¶Ñ **Paso 10** Primer mapa interactivo con `leaflet` y **mapa de calor** con la funci√≥n `addHeatmap()` del paquete `leaflet.extras`.

```{r}
leaflet(data = accidentes2020_data) |>
  addTiles() |>
  addHeatmap(lng = ~longitude, lat = ~latitude, 
             blur = 40, max = 0.05) |> #
  addLegend(position = "bottomright", 
            title = "Accidentes", 
            colors = c("blue", "green", "yellow", "red"), 
            labels = c("Baja", "Media", "Alta", "Muy Alta"), 
            opacity = 0.7)
```





::: {.callout-tip}
## C√≥mo narrar una historia convincente con tus datos.

Hemos visto el **planteamiento**, en el que proporcionamos el contexto: el mism√≠simo alcalde de Madrid se ha enterado de nuestras excelentes capacidades y nos ha pedido ayuda.

El an√°lisis exploratorio nos ha introducido en la **trama**, donde descubrimos una fuerte dependencia de la **hora del d√≠a** y del **lugar** donde se produce el accidente, y que algunos **tipos de accidentes** son m√°s frecuentes que otros.

Pero, como siempre, lo m√°s importante es el **desenlace**, donde presentamos al alcalde las conclusiones m√°s interesantes, que podemos resumir en un par de gr√°ficos:

+ Con un **gr√°fico de barras ordenado** (o un **lollipop**), mostramos los tipos de accidentes m√°s frecuentes en la ciudad de Madrid.

+ Con el **gr√°fico de evoluci√≥n** del n√∫mero de accidentes a lo largo del d√≠a, se puede observar que entre las 14 y 19 horas se produce el mayor n√∫mero de accidentes.

+ Con un **mapa interactivo** (podemos elegir cu√°l nos proporciona la mejor visualizaci√≥n), le damos la posibilidad de explorar din√°micamente qu√© zonas necesitan m√°s acciones de protecci√≥n.



:::

ü§î **Para pensar**

Te hemos propuesto un par de visualizaciones, pero puede que no est√©s de acuerdo. ¬øQu√© visualizaciones utilizar√≠as en el desenlace para aportar el mayor conocimiento a Almeida sobre los accidentes de tr√°fico en su ciudad?

![](img/logos_finan.png){align="right"}
