---
title: "Storytelling visual con R"
subtitle: "쮺칩mo y d칩nde se producen los accidentes en Madrid?"
author:   
  - name: Gema Fern치ndez-Avil칠s 
    email: gema.faviles@uclm.es
  - name: Isidro Hidalgo
    email: isidro.hidalgo@uclm.es 
date: "`r Sys.Date()`"
format:
  html:
    theme: cerulean
    highlight-style: ayu-mirage
    self-contained: true
    lang: es
    date-format: long
    embed-resources: true
    toc-title: Summary
    toc: true
    number-sections: true
    preview-links: auto
    code-link: true
number-sections: true
execute:
  echo: true
  eval: true
  output: true
  include: true
  freeze: auto
  fig-height: 5
  warning: false
  comment: "#>"
  code-line-numbers: true
  code-copy: true
  code-overflow: scroll
---



::: {.callout-warning}
## IMPORTANTE

**Como buen estudiante que eres, sabr치s lo importante que es trabajar de forma aut칩noma y venir a clase con el material le칤do 游땕**. 
:::





::: {.callout-note}
Los datos que se utilizan en esta historia est치n disponibles en el paquete `CDR` que puede instalarse con el siguiente comando (se comprueba si no lo est치):

``` {r}
#| code-summary: Instalaci칩n y/o carga del paquete `CDR`

if (!require(CDR)){
  if (!require(remotes)) {install.packages("remotes")}
  remotes::install_github("cdr-book/CDR")
  }
```

Accidentes de tr치fico en la Ciudad de Madrid registrados por Polic칤a Municipal con v칤ctimas y/o da침os al patrimonio en el 2020. Los datos se han descargado del [Portal de datos abiertos del Ayuntamiento de Madrid.](https://datos.madrid.es/portal/site/egob/menuitem.c05c1f754a33a9fbe4b2e4b284f1a5a0/?vgnextoid=7c2843010d9c3610VgnVCM2000001f4a900aRCRD&vgnextchannel=374512b9ace9f310VgnVCM100000171f5a0aRCRD&vgnextfmt=default))
:::

# C칩mo y d칩nde se producen los accidentes en Madrid

Esta ma침ana estaba tan tranquilo en mi oficina (trabajo en el distrito de Chamart칤n para el Ayuntamiento) y me sueltan de repente: "el jefe quiere verte". Lo primero que he pensado es que me echaban, como soy un poco "cansa almas"... Pero no, entro en el despacho del jefe... 춰Y all칤 est치 Almeida! Que ha o칤do que he hecho un curso de visualizaci칩n en la UCLM y me he convertido en un crack de la visualizaci칩n. Yo no sab칤a donde meterme, pero he mantenido perfectamente la compostura, como un profesional.

As칤 que ya me ha ido contando que est치 muy preocupado con los accidentes y quiere analizar el tema, para buscar soluciones. Que me agradecer칤a mucho si encontramos d칩nde est치 el problema, para bajar el n칰mero y gravedad de los accidentes en la ciudad. El problema, me dice, es que solo me puede facilitar los datos del a침o 2020. Ya le he avisado de que es un a침o muy particular, por el estado de alarma, pero algo sacaremos...

# Entender el contexto

::: {.callout-tip}
## C칩mo definir el prop칩sito y la audiencia de tu an치lisis

쯈u칠 le interesa al alcalde? Bajar la tasa de accidentes. Pero desde el punto de vista de la visualizaci칩n, est치 claro que va a necesitar informaci칩n georreferenciada, por lo que haremos mapas. Por otro lado, seguro que la dimensi칩n es importante, porque no es lo mismo Madrid en agosto que un d칤a de lluvia en calendario escolar...

En cualquier caso, lo primero es hacer un an치lisis exploratorio para ver si hay algo raro en los datos y analizar m칤nimamente las variables de inter칠s. Y despu칠s, le vamos a preparar los gr치ficos necesarios para **aportarle conocimiento** sobre los accidentes en la ciudad.
:::

```{r}
#| code-summary: Configuraci칩n inicial y datos

library(CDR)               # Carga el paquete CDR para la lectura de datos
library(tidyverse)         # Manipulaci칩n y visualizaci칩n de datos
library(sf)                # Para trabajar con datos espaciales
library(mapSpain)          # Para obtener y visualizar mapas de Espa침a
library(tidyterra)         # Para trabajar con datos espaciales y raster
library(lubridate)         # Manipulaci칩n de fechas y horas
library(data.table)        # Para manipulaci칩n eficiente de datos
library(gplots)            # Carga el paquete gplots para crear gr치ficos avanzados
library(RColorBrewer)      # Carga el paquete RColorBrewer para paletas de colores
library(leaflet)           # Carga el paquete leaflet para crear mapas interactivos
library(leaflet.extras)    # Carga el paquete leaflet.extras para funcionalidades adicionales en leaflet
library(ggmosaic)          # Carga el paquete ggmosaic para crear gr치ficos de mosaico
```

# Elegir una visualizaci칩n adecuada

::: {.callout-tip}
## Selecci칩n de gr치ficos y visualizaciones que mejor representen tus datos.
:::


## Almeida quiere saber c칩mo y d칩nde se producen los accidentes en Madrid

::: {#exr-1}
쮻칩nde se han producido los accidentes de tr치fico en Madrid en el 2020?
:::

```{r}
#| code-summary: primer mapa

data(accidentes2020_data)
head(accidentes2020_data)
```


```{r}
#| code-summary: primer mapa
ggplot(data = accidentes2020_data,                          # Crea un gr치fico con el dataset accidentes2020_data
       aes(x = coordenada_x_utm, y = coordenada_y_utm)) +   # x= coordenada_x_utm e y= coordenada_y_utm  
  geom_point() +                                            # A침ade puntos al gr치fico para cada observaci칩n 
  coord_fixed()                                             # Mantiene una relaci칩n fija entre las unidades del eje x y el eje y
```

## El desorden es tu enemigo

Deja mucho que desear, 쯨erdad?: no tenemos informaci칩n, solo unos datos representados en un gr치fico. Con muy poco, tirando de est칠tica (reduciendo la dimensi칩n de los puntos para que se vea el fondo) y alguna referencia geogr치fica (en forma de mapa de carreteras), veremos c칩mo se reduce la carga cognitiva:

### Paso 1: # Convierte el dataset accidentes2020_data a un objeto `sf`
```{r}
accidentes2020_sf <- st_as_sf(accidentes2020_data,     
  coords = c("coordenada_x_utm", "coordenada_y_utm"),  # Define las columnas de coordenadas UTM
  crs = 25830                                          # Establece el sistema de referencia de coordenadas a ETRS89/UTM zona 30N, usado en Europa
)
```

### Paso 2: Obtiene datos del municipio de Madrid con la funci칩n `esp_get_munic` de la libre칤ra `mapSpain`
```{r}
madrid <- esp_get_munic(munic = "^Madrid$") |>    # Obtiene los datos del municipio de Madrid
  st_transform(25830)                             # Transforma las coordenadas al sistema de referencia ETRS89/UTM zona 30N

# Descarga una imagen de un mapa est치tico de las carreteras de Madrid
tile <- esp_getTiles(madrid, "IDErioja", zoommin = 2)
```

### Paso 3: Primer mapa mejorado

```{r}
ggplot() +                                     # Inicia un gr치fico vac칤o con ggplot
  geom_spatraster_rgb(data = tile) +           # A침ade la imagen del mapa est치tico como fondo
  geom_sf(data = accidentes2020_sf,            # A침ade los datos de accidentes como puntos en el mapa
    col = "blue", size = 0.05, alpha = 0.3) +  # Define el color, tama침o y transparencia de los puntos
  coord_sf(expand = FALSE) +                   # Mantiene las proporciones de las coordenadas sin expansi칩n
  labs(title = "쮻칩nde se producen los accidentes de tr치fico en Madrid?")   
```



춰Esto ya es otra cosa! Apreciamos, l칩gicamente, la concentraci칩n de accidentes en el centro de la ciudad y, especialmente, en las arterias principales.

## El cu치ndo

Adem치s, como hemos comentado, tenemos conocimiento *a priori* sobre la influencia de la fecha en el aumento de tr치fico, por lo que probablemente encontremos alguna influencia de la dimensi칩n temporal. Vamos a verlo...

::: {#exr-2}
쮺u치ndo se han producido los accidentes? 
:::

```{r}
#| code-summary: primer gr치fico del cu치ndo

ggplot(data = accidentes2020_data,
       aes(x = fecha, y = hora)) + 
  geom_point() +
  theme_minimal()
```